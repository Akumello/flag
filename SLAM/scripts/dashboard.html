<script>
/**
 * ============================================================================
 * DASHBOARD RENDERING FUNCTIONS
 * ============================================================================
 * Functions for rendering and updating the dashboard view including:
 * - Dashboard statistics (total, met, at-risk, on-track SLAs)
 * - Interactive D3.js performance chart
 * - Recent SLAs display
 * 
 * Dependencies: D3.js, utils.html (getProgressBarClass, getStatusBadgeClass)
 * ============================================================================
 */

/**
 * Updates the dashboard statistics including total SLAs, met, at-risk, and on-track counts.
 * Also creates the interactive D3 performance chart.
 * Safely skips if data is not yet available.
 * @returns {void}
 */
function updateDashboardStats() {
    // Check if data is available before proceeding
    if (!window.APP_DATA || !window.APP_DATA.slas || !Array.isArray(window.APP_DATA.slas)) {
        console.log('Dashboard stats update skipped - data not yet available');
        return;
    }

    const stats = {
        total: window.APP_DATA.slas.length,
        na: window.APP_DATA.slas.filter(sla => sla.status === 'n-a').length,
        notStarted: window.APP_DATA.slas.filter(sla => sla.status === 'not-started').length,
        pendingRequest: window.APP_DATA.slas.filter(sla => sla.status === 'pending-request').length,
        ontrack: window.APP_DATA.slas.filter(sla => sla.status === 'on-track').length,
        atRisk: window.APP_DATA.slas.filter(sla => sla.status === 'at-risk').length,
        met: window.APP_DATA.slas.filter(sla => sla.status === 'met').length,
        exceeded: window.APP_DATA.slas.filter(sla => sla.status === 'exceeded').length,
        missed: window.APP_DATA.slas.filter(sla => sla.status === 'missed').length
    };

    // Update stat cards with actual data
    const statCards = document.querySelectorAll('#dashboard .bg-surface p.text-3xl');
    if (statCards[0]) statCards[0].textContent = stats.total;
    if (statCards[1]) statCards[1].textContent = stats.na;
    if (statCards[2]) statCards[2].textContent = stats.notStarted;
    if (statCards[3]) statCards[3].textContent = stats.pendingRequest;
    if (statCards[4]) statCards[4].textContent = stats.ontrack;
    if (statCards[5]) statCards[5].textContent = stats.atRisk;
    if (statCards[6]) statCards[6].textContent = stats.met;
    if (statCards[7]) statCards[7].textContent = stats.exceeded;
    if (statCards[8]) statCards[8].textContent = stats.missed;
    
    // Create pie chart data
    const chartContainer = document.getElementById('performance-chart-container');
    if (chartContainer) {
        createSLABreakoutPieChart(stats);
    }
}

/**
 * Creates an interactive D3.js pie chart showing SLA status distribution.
 * @param {Object} stats - Object containing counts for each status
 * @returns {void}
 */
function createSLABreakoutPieChart(stats) {
    const container = d3.select("#performance-chart-container");
    container.selectAll("*").remove();
    
    // Prepare data for pie chart (exclude total, only include non-zero statuses)
    const pieData = [
        { label: 'N/A', value: stats.na, color: getComputedStyle(document.documentElement).getPropertyValue('--color-status-info').trim() },
        { label: 'Not Started', value: stats.notStarted, color: getComputedStyle(document.documentElement).getPropertyValue('--color-gray').trim() },
        { label: 'Pending Request', value: stats.pendingRequest, color: '#6366f1' },
        { label: 'On Track', value: stats.ontrack, color: getComputedStyle(document.documentElement).getPropertyValue('--color-status-ontrack').trim() },
        { label: 'At Risk', value: stats.atRisk, color: getComputedStyle(document.documentElement).getPropertyValue('--color-status-warning').trim() },
        { label: 'Met', value: stats.met, color: getComputedStyle(document.documentElement).getPropertyValue('--color-status-success').trim() },
        { label: 'Exceeded', value: stats.exceeded, color: '#10b981' },
        { label: 'Missed', value: stats.missed, color: getComputedStyle(document.documentElement).getPropertyValue('--color-status-danger').trim() }
    ].filter(d => d.value > 0); // Only show statuses with at least 1 SLA
    
    if (pieData.length === 0) {
        container.html('<div class="text-muted">No SLA data available</div>');
        return;
    }
    
    const width = 256;
    const height = 256;
    const radius = Math.min(width, height) / 2;
    
    const svg = container.append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2}, ${height / 2})`);
    
    // Create pie layout
    const pie = d3.pie()
        .value(d => d.value)
        .sort(null);
    
    // Create arc generator
    const arc = d3.arc()
        .innerRadius(0)
        .outerRadius(radius - 10);
    
    // Create pie slices
    const slices = svg.selectAll("path")
        .data(pie(pieData))
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("fill", d => d.data.color)
        .attr("stroke", "var(--color-bg-primary)")
        .attr("stroke-width", 2)
        .style("cursor", "pointer")
        .style("transition", "fill 0.2s ease")
        .on("mouseover", function(event, d) {
            // Change color on hover (brighten by reducing opacity slightly)
            d3.select(this)
                .transition()
                .duration(150)
                .style("opacity", 0.8);
            
            // Show tooltip
            const tooltip = container.append("div")
                .attr("class", "pie-tooltip")
                .style("position", "absolute")
                .style("background", "var(--color-bg-secondary)")
                .style("padding", "8px 12px")
                .style("border-radius", "6px")
                .style("border", "1px solid var(--color-border)")
                .style("box-shadow", "0 4px 6px rgba(0,0,0,0.1)")
                .style("pointer-events", "none")
                .style("z-index", "1000")
                .html(`
                    <div style="color: var(--color-text-primary); font-size: 12px;">
                        <strong>${d.data.label}</strong><br>
                        Count: ${d.data.value}<br>
                        ${((d.data.value / stats.total) * 100).toFixed(1)}%
                    </div>
                `);
            
            // Position tooltip to the left of the cursor
            tooltip
                .style("left", `${event.offsetX - 120}px`)
                .style("top", `${event.offsetY - 20}px`);
        })
        .on("mousemove", function(event, d) {
            // Update tooltip position as mouse moves
            const tooltip = container.select(".pie-tooltip");
            if (!tooltip.empty()) {
                // Position tooltip to the left of the cursor
                tooltip
                    .style("left", `${event.offsetX - 120}px`)
                    .style("top", `${event.offsetY - 20}px`);
            }
        })
        .on("mouseout", function() {
            // Restore original opacity
            d3.select(this)
                .transition()
                .duration(150)
                .style("opacity", 1);
            
            container.selectAll(".pie-tooltip").remove();
        });
    
    // Add legend
    const legend = container.append("div")
        .style("margin-top", "20px")
        .style("display", "grid")
        .style("grid-template-columns", "1fr 1fr")
        .style("gap", "8px")
        .style("font-size", "11px");
    
    pieData.forEach(d => {
        const legendItem = legend.append("div")
            .style("display", "flex")
            .style("align-items", "center")
            .style("gap", "6px");
        
        legendItem.append("div")
            .style("width", "12px")
            .style("height", "12px")
            .style("border-radius", "2px")
            .style("background-color", d.color)
            .style("flex-shrink", "0");
        
        legendItem.append("span")
            .style("color", "var(--color-text-secondary)")
            .text(`${d.label} (${d.value})`);
    });
}

/**
 * Updates the "Recent SLAs" section on the dashboard with the latest 3 SLAs.
 * Safely skips if data is not yet available.
 * @returns {void}
 */
function updateDashboardRecentSLAs() {
    const recentContainer = document.getElementById('recent-slas-container');
    if (!recentContainer) return;

    // Check if data is available before proceeding
    if (!window.APP_DATA || !window.APP_DATA.slas || !Array.isArray(window.APP_DATA.slas)) {
        console.log('Dashboard recent SLAs update skipped - data not yet available');
        return;
    }

    const recentSLAs = window.APP_DATA.slas.slice(0, 3); // Show first 3 SLAs
    recentContainer.innerHTML = recentSLAs.map(sla => {
        const progress = calculateProgress(sla);
        return `
        <div class="flex items-center justify-between py-3 border-b border-color">
            <div class="flex-1">
                <h4 class="text-sm font-medium text-primary-color cursor-pointer hover:text-primary" style="color: var(--color-text-primary)" onclick="showSLADetail('${sla.slaId}')">${sla.slaName}</h4>
                <p class="text-xs text-muted">${(sla.slaType || '').toUpperCase()}</p>
            </div>
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <div class="w-16 rounded-full h-2" style="background-color: var(--color-gray-light)">
                        <div class="${getProgressBarClass(sla.status)} h-2 rounded-full progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <span class="text-sm text-secondary-color">${progress}%</span>
                </div>
                <span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadgeClass(sla.status)}" style="min-width: 4rem;">${formatStatusDisplay(sla.status)}</span>
            </div>
        </div>
        `;
    }).join('');
}

// Export functions to window object for global access
window.updateDashboardStats = updateDashboardStats;
window.createSLABreakoutPieChart = createSLABreakoutPieChart;
window.updateDashboardRecentSLAs = updateDashboardRecentSLAs;

</script>
