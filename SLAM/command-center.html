<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23004F87'/><text x='50' y='60' font-size='50' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial'>CC</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <?!= include('styles/theme-variables') ?>
    <?!= include('styles/components') ?>
    <?!= include('styles/tabs') ?>
    
    <!-- Local deployment fallback for CSS loading -->
    <script>
        /**
         * Fallback function to load CSS for local deployment
         * Fetches style HTML files directly and extracts CSS content
         * This handles cases where the include() scriptlet may not work
         */
        function loadStylesLocalFallback() {
            const styleFiles = ['theme-variables', 'components', 'tabs'];
            const baseUrl = new URL('.', window.location.href).href;
            
            styleFiles.forEach(function(file) {
                const styleUrl = baseUrl + 'styles/' + file + '.html';

                console.log('Attempting to fetch fallback CSS from ' + styleUrl);
                
                fetch(styleUrl)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Failed to fetch ' + file + ': ' + response.status);
                        }
                        return response.text();
                    })
                    .then(function(html) {
                        // Extract content between <style> tags
                        var match = html.match(/<style>([\s\S]*?)<\/style>/i);
                        if (match && match[1]) {
                            var styleTag = document.createElement('style');
                            styleTag.textContent = match[1];
                            styleTag.setAttribute('data-source', 'fallback-' + file);
                            document.head.appendChild(styleTag);
                            console.log('Loaded fallback CSS from ' + file);
                        } else {
                            console.warn('No style tags found in ' + file + '.html');
                        }
                    })
                    .catch(function(error) {
                        console.warn('Could not load fallback style for ' + file + ':', error);
                    });
            });
        }
        
        // Check if styles were already loaded via include(), if not use fallback
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in Google Apps Script environment
            const isGasEnvironment = typeof google !== 'undefined' && google.script;
            
            if (!isGasEnvironment) {
                console.log('Not in Google Apps Script environment, attempting local fallback CSS loading...');
                loadStylesLocalFallback();
            } else {
                console.log('Google Apps Script environment detected, styles should be inlined via scriptlets');
            }
        });
    </script>
</head>
<body class="bg-background">
    <!-- Navigation -->
    <nav class="shadow-sm border-b border-color" style="background-color: var(--color-primary);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold" style="color: white;">Command Center</h1>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex space-x-4">
                        <button onclick="showSection('dashboard')" id="nav-dashboard" class="nav-btn font-medium" style="color: white; opacity: 1;">Dashboard</button>
                        <button onclick="showSection('list')" id="nav-list" class="nav-btn" style="color: white; opacity: 0.8;">All SLAs</button>
                    </div>
                    
                    <!-- Refresh Button -->
                    <div class="flex items-center">
                        <button id="refreshButton" onclick="refreshSLAData()" class="refresh-btn p-2 rounded-lg transition-colors duration-200" style="background-color: rgba(255, 255, 255, 0.1);" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'" title="Refresh SLA data">
                            <i id="refreshIcon" class="bi bi-arrow-clockwise text-lg" style="color: white;"></i>
                        </button>
                    </div>
                    
                    <!-- Theme Toggle -->
                    <div class="flex items-center">
                        <button id="themeToggle" onclick="toggleTheme()" class="theme-toggle-btn p-2 rounded-lg transition-colors duration-200" style="background-color: rgba(255, 255, 255, 0.1);" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'">
                            <i id="themeIcon" class="bi bi-sun text-lg" style="color: white;"></i>
                        </button>
                    </div>

                    <!-- Profile Button -->
                    <div class="flex items-center relative">
                        <button id="profileButton" onclick="toggleProfileMenu()" class="profile-btn flex items-center space-x-2 p-2 rounded-lg transition-colors duration-200" style="background-color: rgba(255, 255, 255, 0.1);" onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'">
                            <img id="profilePicture" src="" alt="Profile" class="w-8 h-8 rounded-full border-2 border-white" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNGM0Y0RjYiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxMiIgcj0iNSIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNCAxNkM0IDI2LjQ5IDE0LjUxIDI4IDE2IDI4QzE3LjQ5IDI4IDI4IDI2LjQ5IDI4IDE2QzI4IDEyIDI0IDE2IDIwIDE2SDEyQzggMTYgNCAxMiA0IDE2WiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K'">
                            <span id="profileGreeting" class="text-sm hidden sm:block" style="color: white;">Hi, Demo User!</span>
                        </button>
                        
                        <!-- Profile Dropdown Menu (Hidden by default) -->
                        <div id="profileMenu" class="absolute right-0 top-full mt-2 w-80 bg-surface rounded-lg shadow-lg border border-color z-50 hidden">
                            <div class="p-4 border-b border-color">
                                <div class="flex items-center space-x-3">
                                    <img id="profileMenuPicture" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-gray-300" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNGM0Y0RjYiLz4KPGNpcmNsZSBjeD0iMjQiIGN5PSIxOCIgcj0iNy41IiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik02IDI0QzYgMzkuNzQgMjEuNzYgNDIgMjQgNDJDMjYuMjQgNDIgNDIgMzkuNzQgNDIgMjRDNDIgMTggMzYgMjQgMzAgMjRIMThDMTIgMjQgNiAxOCA2IDI0WiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K'">
                                    <div>
                                        <div id="profileMenuName" class="font-medium text-primary-color">Demo User</div>
                                        <div id="profileMenuEmail" class="text-sm text-muted">demo@example.com</div>
                                        <div id="profileMenuDepartment" class="text-xs text-secondary-color">General</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional User Details Section -->
                            <div class="p-4 border-b border-color">
                                <div class="grid grid-cols-2 gap-3 text-xs">
                                    <div>
                                        <div class="text-muted font-medium mb-1">Role</div>
                                        <div id="profileMenuRole" class="text-secondary-color">SLA Manager</div>
                                    </div>
                                    <div>
                                        <div class="text-muted font-medium mb-1">Security Level</div>
                                        <div id="profileMenuSecurityLevel" class="text-secondary-color">Level 3</div>
                                    </div>
                                    <div>
                                        <div class="text-muted font-medium mb-1">Employee ID</div>
                                        <div id="profileMenuEmployeeId" class="text-secondary-color">EMP-2024-0157</div>
                                    </div>
                                    <div>
                                        <div class="text-muted font-medium mb-1">Last Login</div>
                                        <div id="profileMenuLastLogin" class="text-secondary-color">Today 9:30 AM</div>
                                    </div>
                                    <div>
                                        <div class="text-muted font-medium mb-1">Office Location</div>
                                        <div id="profileMenuLocation" class="text-secondary-color">Washington, DC</div>
                                    </div>
                                    <div>
                                        <div class="text-muted font-medium mb-1">Phone</div>
                                        <div id="profileMenuPhone" class="text-secondary-color">(202) 555-0173</div>
                                    </div>
                                    <div class="col-span-2">
                                        <div class="text-muted font-medium mb-1">Access Permissions</div>
                                        <div id="profileMenuPermissions" class="text-secondary-color flex flex-wrap gap-1">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">View SLAs</span>
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Edit Tasks</span>
                                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">Reports</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Statistics Section -->
                            <div class="p-3 border-b border-color">
                                <div class="text-xs text-muted font-medium mb-2">My Activity</div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div>
                                        <div id="profileMenuTasksAssigned" class="font-bold text-primary-color">12</div>
                                        <div class="text-xs text-muted">Assigned</div>
                                    </div>
                                    <div>
                                        <div id="profileMenuTasksCompleted" class="font-bold text-green-600">8</div>
                                        <div class="text-xs text-muted">Completed</div>
                                    </div>
                                    <div>
                                        <div id="profileMenuTasksOverdue" class="font-bold text-red-600">2</div>
                                        <div class="text-xs text-muted">Overdue</div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-2">
                                <button class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-secondary-color">
                                    <i class="bi bi-person mr-2"></i>My Profile
                                </button>
                                <button class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-secondary-color">
                                    <i class="bi bi-bell mr-2"></i>Notifications
                                </button>
                                <button class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-secondary-color">
                                    <i class="bi bi-gear mr-2"></i>Settings
                                </button>
                                <button class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-secondary-color">
                                    <i class="bi bi-question-circle mr-2"></i>Help & Support
                                </button>
                                <hr class="my-2 border-color">
                                <button class="w-full text-left px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-sm text-red-600">
                                    <i class="bi bi-box-arrow-right mr-2"></i>Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section active">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-surface p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-secondary-color">Total SLAs</p>
                            <p class="text-3xl font-bold text-primary-color">12</p>
                        </div>
                        <div class="w-12 h-12 stat-card-blue rounded-lg flex items-center justify-center">
                            <i class="bi bi-bar-chart text-xl" style="color: var(--color-status-info)"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-surface p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-secondary-color">Met SLAs</p>
                            <p class="text-3xl font-bold" style="color: var(--color-status-success)">8</p>
                        </div>
                        <div class="w-12 h-12 stat-card-green rounded-lg flex items-center justify-center">
                            <i class="bi bi-check-circle text-xl" style="color: var(--color-status-success)"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-surface p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-secondary-color">At Risk</p>
                            <p class="text-3xl font-bold" style="color: var(--color-status-warning)">3</p>
                        </div>
                        <div class="w-12 h-12 stat-card-orange rounded-lg flex items-center justify-center">
                            <i class="bi bi-exclamation-triangle text-xl" style="color: var(--color-status-warning)"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-surface p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-secondary-color">On Track SLAs</p>
                            <p class="text-3xl font-bold" style="color: var(--color-status-ontrack)">1</p>
                        </div>
                        <div class="w-12 h-12 stat-card-ontrack rounded-lg flex items-center justify-center">
                            <i class="bi bi-check-circle-fill text-xl" style="color: var(--color-status-ontrack)"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-surface rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-primary-color">Recent SLAs</h2>
                        <button onclick="showSection('list')" class="link-primary text-sm hover:underline">View all</button>
                    </div>
                    <div class="space-y-4" id="recent-slas-container">
                        <!-- Recent SLAs will be populated by updateDashboardRecentSLAs() -->
                    </div>
                </div>

                <div class="bg-surface rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-primary-color">SLA Performance</h2>
                    <div class="h-64 flex items-center justify-center" id="performance-chart-container">
                        <!-- Performance stats will be populated by updateDashboardStats() -->
                        <div class="w-full">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-secondary-color">This Month</span>
                                    <span class="text-sm font-medium" style="color: var(--color-status-success)">Loading...</span>
                                </div>
                                <div class="w-full rounded-full h-4" style="background-color: var(--color-gray-light)">
                                    <div class="progress-success h-4 rounded-full progress-bar" style="width: 0%"></div>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-4 mt-6">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" style="color: var(--color-status-success)">0%</div>
                                        <div class="text-xs text-muted">Met</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" style="color: var(--color-status-warning)">0%</div>
                                        <div class="text-xs text-muted">At Risk</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold" style="color: var(--color-status-ontrack)">0%</div>
                                        <div class="text-xs text-muted">On Track</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create SLA Section -->
    <div id="create" class="section">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-surface rounded-lg shadow-sm p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <button type="button" onclick="goBack()" class="px-4 py-2 rounded-md btn-secondary flex items-center gap-2">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <h2 class="text-2xl font-bold text-primary-color">Create SLAs</h2>
                    </div>
                    <button type="submit" onclick="submitSLAs()" class="px-6 py-2 rounded-md btn-primary" id="topSubmitButton" style="display: none;">
                        Create All SLAs
                    </button>
                </div>
                
                <!-- SLA Tabs -->
                <div class="mb-6" id="slaTabsSection">
                    <div class="flex items-center gap-2 p-4 bg-gray-50 rounded-lg">
                        <nav class="flex gap-2" id="slaTabs">
                            <!-- Tabs will be added here dynamically -->
                            <button type="button" onclick="addNewSLA()" 
                                    class="add-sla-button flex items-center gap-2">
                                <i class="bi bi-plus"></i> Add SLA
                            </button>
                        </nav>
                    </div>
                </div>
                
                <form id="createSlaForm" class="space-y-6">
                    <div id="slaContainer">
                        <!-- SLA forms will be added here dynamically -->
                    </div>
                </form>
            </div>
        </div>
    </div>

<!-- SLA List Section -->
<div id="list" class="section">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Task Selection List (Initial View) -->
        <div id="task-selection-view">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
                <div class="text-center flex-1">
                    <h2 class="text-2xl font-bold text-primary-color mb-2">All SLAs</h2>
                    <p class="text-muted">Select a task to view related SLAs</p>
                    <div id="user-task-info" class="mt-2 text-sm text-primary-color">
                        Your assigned task is highlighted at the top
                    </div>
                </div>
                <div class="flex justify-center sm:justify-end mt-4 sm:mt-0">
                    <button onclick="showSection('create')" class="px-4 py-2 rounded-md btn-primary flex items-center gap-2">
                        <i class="bi bi-plus"></i> Add SLA
                    </button>
                </div>
            </div>
            
            <!-- All Tasks Button -->
            <div class="mb-4">
                <button onclick="showAllTasksSLAs()" class="w-full px-4 py-3 rounded-md border-2 transition-all duration-200 flex items-center justify-between" style="background: var(--color-primary); border-color: var(--color-primary); color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                    <span class="flex items-center gap-2 font-semibold">
                        <i class="bi bi-grid-3x3-gap-fill text-lg"></i> View All SLAs Across All Tasks
                    </span>
                    <span id="all-tasks-count" class="inline-block bg-white bg-opacity-25 backdrop-blur-sm text-white text-sm font-semibold px-3 py-1 rounded-full border border-white border-opacity-30">0 SLAs</span>
                </button>
            </div>
            
            <div class="space-y-3" id="task-list-container">
                <div onclick="showTaskSLAs('Task 1')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-briefcase text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 1</h3>
                                <p class="text-sm text-muted">Program Management</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-1-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 2')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-people-fill text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 2</h3>
                                <p class="text-sm text-muted">Multi-Team Support</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-2-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 3')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-diagram-3 text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 3</h3>
                                <p class="text-sm text-muted">PPM Operations</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-3-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 4')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-gear-fill text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 4</h3>
                                <p class="text-sm text-muted">Technical Evaluation</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-4-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 5')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-book-fill text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 5</h3>
                                <p class="text-sm text-muted">Training Support</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-5-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 6')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-bar-chart-fill text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 6</h3>
                                <p class="text-sm text-muted">Business Intelligence</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-6-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 7')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-headset text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 7</h3>
                                <p class="text-sm text-muted">Operational Support</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-7-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 8')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-cpu-fill text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 8</h3>
                                <p class="text-sm text-muted">Strategic Planning</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-8-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
                
                <div onclick="showTaskSLAs('Task 9')" class="task-card cursor-pointer bg-surface rounded-lg p-4 border border-color hover:border-primary-color transition-colors duration-200 hover:shadow-md">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-primary-color rounded-full flex items-center justify-center">
                                <i class="bi bi-chat-dots-fill text-lg" style="color: var(--color-text-on-primary)"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-primary-color">Task 9</h3>
                                <p class="text-sm text-muted">Communication</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="task-9-count" class="inline-block bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">0 SLAs</span>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filtered SLA Table View (Hidden by default) -->
        <div id="filtered-sla-view" style="display: none;">
            <!-- Header with Back Button -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div class="flex items-center mb-4 sm:mb-0">
                    <button onclick="showTaskSelection()" class="mr-4 text-secondary-color hover:text-primary-color flex items-center gap-2">
                        <i class="bi bi-arrow-left"></i> Back to Tasks
                    </button>
                    <h2 id="filtered-task-title" class="text-2xl font-bold text-primary-color">Task SLAs</h2>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button onclick="showSection('create')" class="px-4 py-2 rounded-md btn-primary flex items-center gap-2">
                        <i class="bi bi-plus"></i> Add SLA
                    </button>
                </div>
            </div>

            <!-- SLA Table -->
            <div class="bg-surface rounded-lg shadow-sm overflow-hidden">
                <table class="w-full">
                    <thead class="border-b border-color" style="background-color: var(--color-gray-light)">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">SLA Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Team</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Progress</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">End Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="filtered-sla-table-body" class="bg-surface divide-y" style="border-color: var(--color-border)">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <!-- SLA Detail Section -->
    <div id="detail" class="section">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <button onclick="showSection('list')" class="mr-4 text-secondary-color hover:text-primary-color flex items-center gap-2">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </button>
                    <h2 class="text-2xl font-bold text-primary-color">SLA Details</h2>
                </div>
                <div class="flex space-x-3">
                    <button onclick="showUpdateModal()" class="px-4 py-2 rounded-md btn-success">Update Progress</button>
                    <button onclick="enableInlineEditing(currentSlaId)" class="px-4 py-2 rounded-md btn-secondary">Edit</button>
                    <button class="px-4 py-2 rounded-md btn-danger">Delete</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- SLA Overview -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Overview</h3>
                        <div class="space-y-4">
                            <!-- Dynamic content will be inserted here by renderSLADetail() -->
                        </div>
                    </div>

                    <!-- Progress Tracking -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Progress Tracking</h3>
                        <div class="space-y-4">
                            <!-- Dynamic progress content will be inserted here by renderProgressTracking() -->
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Activity Log</h3>
                        <div class="space-y-3">
                            <!-- Dynamic activity log will be inserted here by renderActivityLog() -->
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Status Card -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Status</h3>
                        <div class="space-y-3">
                            <!-- Dynamic status content will be inserted here by renderSLASidebar() -->
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Quick Stats</h3>
                        <div class="space-y-3">
                            <!-- Dynamic quick stats will be inserted here by renderSLASidebar() -->
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Notifications</h3>
                        <div class="space-y-3">
                            <!-- Dynamic notification settings will be inserted here by renderSLASidebar() -->
                        </div>
                    </div>

                    <!-- Audit Information -->
                    <div class="bg-surface rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-primary-color mb-4">Audit Trail</h3>
                        <div class="space-y-3">
                            <!-- Audit information will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Progress Modals - Type Specific -->
    
    <!-- Quantity Update Modal -->
    <div id="updateModal-quantity" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Quantity</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateQuantityValue" class="block text-sm font-medium text-primary-color mb-2">Current Quantity</label>
                    <input type="number" id="updateQuantityValue" 
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateQuantityNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateQuantityNotes" rows="3" placeholder="Optional notes about this update..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Percentage Update Modal -->
    <div id="updateModal-percentage" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Percentage</h3>
            <div class="space-y-4">
                <div>
                    <label for="updatePercentageValue" class="block text-sm font-medium text-primary-color mb-2">Current Percentage (%)</label>
                    <input type="number" id="updatePercentageValue" min="0" max="100" step="0.1"
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updatePercentageNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updatePercentageNotes" rows="3" placeholder="Optional notes about this update..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Timeliness Update Modal -->
    <div id="updateModal-timeliness" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Timeliness</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateTimelinessDate" class="block text-sm font-medium text-primary-color mb-2">Completion Date</label>
                    <input type="date" id="updateTimelinessDate" 
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateTimelinessTime" class="block text-sm font-medium text-primary-color mb-2">Completion Time</label>
                    <input type="time" id="updateTimelinessTime" 
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateTimelinessNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateTimelinessNotes" rows="3" placeholder="Optional notes about this completion..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Mark Complete</button>
            </div>
        </div>
    </div>

    <!-- Availability Update Modal -->
    <div id="updateModal-availability" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Availability</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateAvailabilityValue" class="block text-sm font-medium text-primary-color mb-2">Uptime Percentage (%)</label>
                    <input type="number" id="updateAvailabilityValue" min="0" max="100" step="0.01"
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateAvailabilityDowntime" class="block text-sm font-medium text-primary-color mb-2">Downtime (minutes)</label>
                    <input type="number" id="updateAvailabilityDowntime" min="0"
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateAvailabilityNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateAvailabilityNotes" rows="3" placeholder="Optional notes about this update..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Compliance Update Modal -->
    <div id="updateModal-compliance" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Compliance Status</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateComplianceStatus" class="block text-sm font-medium text-primary-color mb-2">Compliance Status</label>
                    <select id="updateComplianceStatus" class="w-full px-3 py-2 border border-color rounded-md">
                        <option value="true">Compliant</option>
                        <option value="false">Not Compliant</option>
                    </select>
                </div>
                <div>
                    <label for="updateComplianceNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateComplianceNotes" rows="3" placeholder="Optional notes about compliance status..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Composite/Multi-Metric Update Modal -->
    <div id="updateModal-composite" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Composite Score</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateCompositeScore" class="block text-sm font-medium text-primary-color mb-2">Weighted Score</label>
                    <input type="number" id="updateCompositeScore" step="0.1"
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateCompositeNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateCompositeNotes" rows="3" placeholder="Optional notes about this update..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Multi-Metric Update Modal (same as composite) -->
    <div id="updateModal-multi-metric" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Multi-Metric Score</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateMultiMetricScore" class="block text-sm font-medium text-primary-color mb-2">Overall Score</label>
                    <input type="number" id="updateMultiMetricScore" step="0.1"
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateMultiMetricNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateMultiMetricNotes" rows="3" placeholder="Optional notes about this update..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Recurring Update Modal -->
    <div id="updateModal-recurring" class="update-modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-surface rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-primary-color mb-4">Update Recurring SLA</h3>
            <div class="space-y-4">
                <div>
                    <label for="updateRecurringValue" class="block text-sm font-medium text-primary-color mb-2">Current Period Value</label>
                    <input type="number" id="updateRecurringValue" 
                           class="w-full px-3 py-2 border border-color rounded-md">
                </div>
                <div>
                    <label for="updateRecurringNotes" class="block text-sm font-medium text-primary-color mb-2">Notes</label>
                    <textarea id="updateRecurringNotes" rows="3" placeholder="Optional notes about this period..."
                              class="w-full px-3 py-2 border border-color rounded-md"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="hideUpdateModal()" class="px-4 py-2 rounded-md btn-secondary">Cancel</button>
                <button onclick="saveUpdate()" class="px-4 py-2 rounded-md btn-primary">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="hidden fixed top-4 right-4 px-6 py-3 rounded-md z-50"></div>

    <!-- Server-side Data Injection -->
    <script>
    <?!= generateDataInjectionScript(); ?>
    </script>

    <!-- Utility Functions (must load first - no dependencies) -->
    <?!= HtmlService.createHtmlOutputFromFile('scripts/utils').getContent(); ?>

    <!-- Team Configuration (must load before other scripts that use it) -->
    <?!= HtmlService.createHtmlOutputFromFile('scripts/team-config').getContent(); ?>

    <!-- Backend Integration Scripts -->
    <?!= HtmlService.createHtmlOutputFromFile('scripts/backend-integration').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('scripts/inline-editor').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('scripts/form-builder').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('scripts/sla-detail-renderer').getContent(); ?>
    <?!= HtmlService.createHtmlOutputFromFile('scripts/dashboard').getContent(); ?>

    <!-- Local Development Script Loader -->
    <script>
        /**
         * Load script content from HTML files for local development
         * This function extracts <script> content from scriptlet-style HTML files
         */
        function loadScriptFromHTML(filename) {
            return fetch(filename)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load ' + filename + ': ' + response.status);
                    }
                    return response.text();
                })
                .then(html => {
                    // Extract script content from HTML file
                    const scriptMatch = html.match(/<script>([\s\S]*?)<\/script>/);
                    if (scriptMatch) {
                        const script = document.createElement('script');
                        script.textContent = scriptMatch[1];
                        document.body.appendChild(script);
                        console.log('✅ Loaded: ' + filename);
                    } else {
                        console.warn('⚠️ No script found in ' + filename);
                    }
                })
                .catch(error => {
                    console.error('❌ Error loading ' + filename + ':', error);
                });
        }

        /**
         * Detect if running in GAS or local environment
         * Load scripts dynamically if in local environment
         */
        (function() {
            const isGAS = typeof google !== 'undefined' && google.script && google.script.run;
            
            if (!isGAS) {
                console.log('🔧 Local development mode detected - loading scripts dynamically');
                
                // Load scripts in sequence to ensure proper dependency order
                // utils must load first as other modules depend on it
                // team-config must load before other scripts that use team data
                Promise.resolve()
                    .then(() => loadScriptFromHTML('scripts/utils.html'))
                    .then(() => loadScriptFromHTML('scripts/team-config.html'))
                    .then(() => loadScriptFromHTML('scripts/backend-integration.html'))
                    .then(() => loadScriptFromHTML('scripts/inline-editor.html'))
                    .then(() => loadScriptFromHTML('scripts/form-builder.html'))
                    .then(() => loadScriptFromHTML('scripts/sla-detail-renderer.html'))
                    .then(() => loadScriptFromHTML('scripts/dashboard.html'))
                    .then(() => {
                        console.log('✅ All scripts loaded successfully');
                        // Dispatch custom event to signal scripts are ready
                        window.dispatchEvent(new Event('scriptsLoaded'));
                    })
                    .catch(error => {
                        console.error('❌ Failed to load scripts:', error);
                    });
            } else {
                console.log('☁️ GAS environment detected - using scriptlets');
            }
        })();
    </script>

<script>
        /**
         * ========================================================================
         * DATA FLOW AND NAMING CONVENTIONS
         * ========================================================================
         * The application uses camelCase throughout to match backend API expectations.
         * 
         * DATA FLOW:
         * 1. Google Sheets: Uses Title Case headers ("SLA Name", "Team ID", "Frequency")
         * 2. Backend _toCamelCase(): Converts headers → camelCase (slaName, teamId, frequency)
         * 3. Backend API: Expects and returns camelCase objects
         * 4. Frontend Display: Uses camelCase from backend (sla.slaName, sla.teamId)
         * 5. Frontend Forms: Collects data in camelCase and sends to backend
         * 
         * NAMING CONVENTION:
         * - Google Sheets Headers: "SLA Name", "Team ID" (Title Case with spaces)
         * - JavaScript/Backend: slaName, teamId (camelCase)
         * - Data Model JSON: sla_name, team_id (snake_case - represents Sheet structure)
         * 
         * The backend serves as the translation layer, ensuring consistent camelCase
         * throughout the JavaScript application layer.
         * ========================================================================
         */

        // Global Variables
        let slaCounter = 0;
        let currentSlaId = null;
        
        // DOM Element Cache for Performance
        const domCache = {
            notification: null,
            taskSelectionView: null,
            filteredSlaView: null,
            init() {
                this.notification = document.getElementById('notification');
                this.taskSelectionView = document.getElementById('task-selection-view');
                this.filteredSlaView = document.getElementById('filtered-sla-view');
            }
        };
        
        // Initialize DOM cache when page loads
        // Application Variables (will be populated by data loader)
        // Use window object to avoid redeclaration issues
        window.APP_DATA = window.APP_DATA || {
            slas: [],
            userData: null,
            isDemo: false,
            source: 'unknown'
        };

        /**
         * Updates the user interface elements with current user information.
         * Checks for data availability before proceeding.
         * @returns {void}
         */
        function updateUserInterface() {
            // Check if user data is available before proceeding
            if (!window.APP_DATA.userData) {
                console.log('User interface update skipped - user data not yet available');
                return;
            }
            
            // Update profile information in the UI
            updateProfileDisplay();
            console.log(`Welcome ${window.APP_DATA.userData.name} from ${window.APP_DATA.userData.department}`);
        }

        /**
         * Updates all profile display elements in the UI with current user data.
         * Includes profile picture, name, email, department, role, and activity stats.
         * Safely skips if user data is not yet available.
         * @returns {void}
         */
        function updateProfileDisplay() {
            // Check if user data is available before proceeding
            if (!window.APP_DATA.userData) {
                console.log('Profile display update skipped - user data not yet available');
                return;
            }

            const profileGreeting = document.getElementById('profileGreeting');
            const profilePicture = document.getElementById('profilePicture');
            const profileMenuPicture = document.getElementById('profileMenuPicture');
            const profileMenuName = document.getElementById('profileMenuName');
            const profileMenuEmail = document.getElementById('profileMenuEmail');
            const profileMenuDepartment = document.getElementById('profileMenuDepartment');
            
            // New profile fields
            const profileMenuRole = document.getElementById('profileMenuRole');
            const profileMenuSecurityLevel = document.getElementById('profileMenuSecurityLevel');
            const profileMenuEmployeeId = document.getElementById('profileMenuEmployeeId');
            const profileMenuLastLogin = document.getElementById('profileMenuLastLogin');
            const profileMenuLocation = document.getElementById('profileMenuLocation');
            const profileMenuPhone = document.getElementById('profileMenuPhone');
            const profileMenuTasksAssigned = document.getElementById('profileMenuTasksAssigned');
            const profileMenuTasksCompleted = document.getElementById('profileMenuTasksCompleted');
            const profileMenuTasksOverdue = document.getElementById('profileMenuTasksOverdue');

            // Update greeting text
            if (profileGreeting) {
                profileGreeting.textContent = `Hi, ${window.APP_DATA.userData.name}!`;
            }

            // Update profile pictures (both in button and menu)
            const profileImageUrl = window.APP_DATA.userData.profilePicture || '';
            if (profilePicture) {
                profilePicture.src = profileImageUrl;
            }
            if (profileMenuPicture) {
                profileMenuPicture.src = profileImageUrl;
            }

            // Update basic menu information
            if (profileMenuName) {
                profileMenuName.textContent = window.APP_DATA.userData.name;
            }
            if (profileMenuEmail) {
                profileMenuEmail.textContent = window.APP_DATA.userData.email;
            }
            if (profileMenuDepartment) {
                profileMenuDepartment.textContent = window.APP_DATA.userData.department;
            }
            
            // Update additional user details
            if (profileMenuRole) {
                profileMenuRole.textContent = window.APP_DATA.userData.role || 'User';
            }
            if (profileMenuSecurityLevel) {
                profileMenuSecurityLevel.textContent = window.APP_DATA.userData.securityLevel || 'Level 1';
            }
            if (profileMenuEmployeeId) {
                profileMenuEmployeeId.textContent = window.APP_DATA.userData.employeeId || 'N/A';
            }
            if (profileMenuLastLogin) {
                profileMenuLastLogin.textContent = window.APP_DATA.userData.lastLogin || 'Unknown';
            }
            if (profileMenuLocation) {
                profileMenuLocation.textContent = window.APP_DATA.userData.office || 'Not specified';
            }
            if (profileMenuPhone) {
                profileMenuPhone.textContent = window.APP_DATA.userData.phone || 'Not provided';
            }
            
            // Update activity statistics
            if (profileMenuTasksAssigned) {
                profileMenuTasksAssigned.textContent = window.APP_DATA.userData.tasksAssigned || '0';
            }
            if (profileMenuTasksCompleted) {
                profileMenuTasksCompleted.textContent = window.APP_DATA.userData.tasksCompleted || '0';
            }
            if (profileMenuTasksOverdue) {
                profileMenuTasksOverdue.textContent = window.APP_DATA.userData.tasksOverdue || '0';
            }
        }

        // Function to toggle profile menu - Make sure it's in global scope
        window.toggleProfileMenu = function() {
            const profileMenu = document.getElementById('profileMenu');
            if (profileMenu) {
                profileMenu.classList.toggle('hidden');
            } else {
                console.error('Profile menu element not found!');
            }
        }

        // Close profile menu when clicking outside
        document.addEventListener('click', function(event) {
            const profileButton = document.getElementById('profileButton');
            const profileMenu = document.getElementById('profileMenu');
            
            if (profileButton && profileMenu && !profileButton.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.add('hidden');
            }
        });

        /**
         * Applies user-specific task organization to the task list.
         * Legacy function name kept for compatibility - delegates to organizeTaskList().
         * @returns {void}
         */
        function applyUserTaskFilter() {
            // Simply organize the task list instead of filtering
            organizeTaskList();
        }

        /**
         * Shows all tasks by removing any active filters and displaying all task cards.
         * Used by the "View All Tasks" button.
         * @returns {void}
         */
        function showAllTasks() {
            const filterInfo = document.getElementById('user-task-filter-info');
            if (filterInfo) {
                filterInfo.style.display = 'none';
            }
            
            // Show all task cards
            const taskCards = document.querySelectorAll('#task-list-container .task-card');
            taskCards.forEach(card => {
                card.style.display = 'block';
            });
            
            // Show task selection view
            showTaskSelection();
        }

        /**
         * Reorganizes the task list to display the user's assigned task at the top,
         * followed by all other tasks. Always shows all tasks, just reorganizes order.
         * @returns {void}
         */
        function organizeTaskList() {
            const container = document.getElementById('task-list-container');
            
            // Check if userData is available and has taskTeam
            if (!container || !window.APP_DATA.userData || !window.APP_DATA.userData.taskTeam || window.APP_DATA.userData.taskTeam === "all") {
                return;
            }

            const taskCards = Array.from(container.querySelectorAll('.task-card'));
            const userTaskCard = taskCards.find(card => {
                const taskName = card.querySelector('h3')?.textContent?.trim();
                return taskName === window.APP_DATA.userData.taskTeam;
            });

            if (userTaskCard) {
                // Add special styling to user's task
                userTaskCard.classList.add('user-task-card');
                
                // Add prominent visual styling
                userTaskCard.style.cssText = `
                    background: rgba(59, 130, 246, 0.08);
                    border: 2px solid var(--color-primary, #3b82f6);
                    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2), 0 2px 4px -1px rgba(59, 130, 246, 0.1);
                    position: relative;
                `;
                
                // Add "My Task" indicator if not already present
                if (!userTaskCard.querySelector('.my-task-indicator')) {
                    const taskTitle = userTaskCard.querySelector('h3');
                    if (taskTitle) {
                        const indicator = document.createElement('span');
                        indicator.className = 'my-task-indicator ml-2 px-2.5 py-0.5 rounded-full text-xs font-semibold';
                        indicator.style.cssText = 'background: var(--color-primary, #3b82f6); color: white; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);';
                        indicator.innerHTML = '<i class="bi bi-star-fill mr-1"></i>My Task';
                        taskTitle.appendChild(indicator);
                    }
                }

                // Move user's task to the top
                container.insertBefore(userTaskCard, container.firstChild);
            }
        }

        // Demo Data - Comprehensive examples of all SLA types and configurations
        // Demo data is now loaded from external file via sla-data-loader.js
        // Original hardcoded data has been moved to sla-sample-data.json

        // Note: Utility functions (formatDate, getStatusBadgeClass, getProgressBarClass, 
        // getActivityIconColor) moved to scripts/utils.html

        // ========================================
        // RENDER FUNCTIONS
        // ========================================

        /**
         * Renders all SLAs in the filtered table view (utility function).
         * Note: Currently not used as the default view shows task selection.
         * Can be used for "Show All SLAs" feature or debugging.
         * Populates the tbody with all SLAs from window.APP_DATA.slas.
         * @returns {void}
         */
        function renderSLAList() {
            // Use the existing filtered SLA table to show all SLAs
            const tbody = document.getElementById('filtered-sla-table-body');
            if (!tbody) {
                console.error('tbody element not found with id "filtered-sla-table-body"');
                return;
            }

            // Check if data is available before proceeding
            if (!window.APP_DATA || !window.APP_DATA.slas || !Array.isArray(window.APP_DATA.slas)) {
                console.warn('SLA List rendering skipped - data not available');
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-muted">No SLA data available</td></tr>';
                return;
            }

            tbody.innerHTML = '';

            window.APP_DATA.slas.forEach((sla, index) => {
                const row = document.createElement('tr');
                row.style.backgroundColor = 'white';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-primary-color cursor-pointer link-primary" onclick="showSLADetail('${sla.slaId}')">${sla.slaName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted">${(sla.slaType || '').charAt(0).toUpperCase() + (sla.slaType || '').slice(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted">${getTeamName(sla.teamId) || 'Unknown Team'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadgeClass(sla.status)}">${sla.status.replace('-', ' ')}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-16 rounded-full h-2 mr-2" style="background-color: var(--color-gray-light)">
                                <div class="${getProgressBarClass(sla.status)} h-2 rounded-full" style="width: ${sla.progress}%"></div>
                            </div>
                            <span class="text-sm text-secondary-color">${sla.progress}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted">${formatDate(sla.endDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showSLADetail('${sla.slaId}')" class="link-primary mr-3">View</button>
                        <button onclick="deleteSLA('${sla.slaId}')" style="color: var(--color-status-error)" class="hover:opacity-80">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Note: renderActivityLog, renderSLADetail, renderProgressTracking, generateMetricsHTML,
        // getTargetDisplay, renderSLASidebar, generateQuickStatsHTML moved to scripts/sla-detail-renderer.html

        // Note: calculateTimeRemaining moved to scripts/utils.html

        // Note: updateDashboardStats, createInteractivePerformanceChart, 
        // updateDashboardRecentSLAs moved to scripts/dashboard.html

        // ========================================
        // DATA REFRESH AND CALLBACK FUNCTIONS
        // ========================================

        /**
         * Refreshes UI components when external data becomes available.
         * Called by the data loader after successful data loading.
         * Always refreshes profile; conditionally refreshes dashboard if visible.
         * @returns {void}
         */
        window.refreshDashboardIfVisible = function() {
            console.log('Data loaded - refreshing UI components...');
            
            // Always refresh profile display since it's visible on all pages
            updateProfileDisplay();
            
            // Always refresh task counts since they may have changed
            updateTaskCounts();
            
            // Check if dashboard section is currently visible
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection && !dashboardSection.classList.contains('hidden')) {
                console.log('Refreshing dashboard with loaded data...');
                updateDashboardStats();
                updateDashboardRecentSLAs();
            }
        };

        // ========================================
        // NAVIGATION AND SECTION MANAGEMENT
        // ========================================

        /**
         * Navigates back to the previous section.
         * Returns to dashboard when in create mode.
         * @returns {void}
         */
        function goBack() {
            // Go back to dashboard
            showSection('dashboard');
        }

        /**
         * Shows a specific section of the application and hides all others.
         * Handles special initialization for certain sections (tasks, dashboard, create).
         * @param {string} sectionName - Name of the section to show ('dashboard', 'list', 'create', 'tasks', 'detail')
         * @returns {void}
         */
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Update navigation active state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('font-medium');
                btn.style.color = 'white';
                btn.style.opacity = '0.8';
            });
            
            // Only update nav button if it exists (since we removed some)
            const activeBtn = document.getElementById(`nav-${sectionName}`);
            if (activeBtn) {
                activeBtn.classList.add('font-medium');
                activeBtn.style.opacity = '1';
            }

            // Render section-specific content
            if (sectionName === 'list') {
                // Show task selection view (default view for list section)
                showTaskSelection();
                updateTaskCounts();
                
                // Always show all tasks but organize with user's task at top
                organizeTaskList();
            } else if (sectionName === 'dashboard') {
                updateDashboardStats();
                updateDashboardRecentSLAs();
            }
            
            // Initialize create section with a fresh tab when entering
            if (sectionName === 'create') {
                // Show tabs section in create mode
                const tabsSection = document.getElementById('slaTabsSection');
                if (tabsSection) {
                    tabsSection.classList.remove('hidden');
                }
                
                // Only reset if there are no existing tabs or forms
                const existingForms = document.querySelectorAll('.sla-form-container');
                if (existingForms.length === 0) {
                    setTimeout(() => {
                        if (slaCounter === 0) {
                            addNewSLA();
                        }
                    }, 100);
                }
            }
        }

        // ========================================
        // TASK SELECTION AND FILTERING FUNCTIONS
        // ========================================

        /**
         * Shows the task selection view and hides the filtered SLA view.
         * Displays the main task grid for users to choose a task.
         * @returns {void}
         */
        function showTaskSelection() {
            if (domCache.taskSelectionView && domCache.filteredSlaView) {
                domCache.taskSelectionView.style.display = 'block';
                domCache.filteredSlaView.style.display = 'none';
            } else {
                // Fallback if cache not initialized
                const taskView = document.getElementById('task-selection-view');
                const filteredView = document.getElementById('filtered-sla-view');
                if (taskView) taskView.style.display = 'block';
                if (filteredView) filteredView.style.display = 'none';
            }
        }
        
        /**
         * Shows the filtered SLA list for a specific task.
         * Hides task selection view and displays SLAs belonging to the chosen task.
         * @param {string} taskName - Name of the task to filter SLAs by
         * @returns {void}
         */
        function showTaskSLAs(taskName) {
            if (domCache.taskSelectionView && domCache.filteredSlaView) {
                domCache.taskSelectionView.style.display = 'none';
                domCache.filteredSlaView.style.display = 'block';
            } else {
                // Fallback if cache not initialized
                const taskView = document.getElementById('task-selection-view');
                const filteredView = document.getElementById('filtered-sla-view');
                if (taskView) taskView.style.display = 'none';
                if (filteredView) filteredView.style.display = 'block';
            }
            
            const titleElement = document.getElementById('filtered-task-title');
            if (titleElement) {
                titleElement.textContent = `${taskName} SLAs`;
            }
            
            // Filter and display SLAs for the selected task
            renderFilteredSLAs(taskName);
        }
        
        /**
         * Shows all SLAs across all tasks without filtering.
         * Displays the complete SLA list in the filtered view.
         * @returns {void}
         */
        function showAllTasksSLAs() {
            if (domCache.taskSelectionView && domCache.filteredSlaView) {
                domCache.taskSelectionView.style.display = 'none';
                domCache.filteredSlaView.style.display = 'block';
            } else {
                // Fallback if cache not initialized
                const taskView = document.getElementById('task-selection-view');
                const filteredView = document.getElementById('filtered-sla-view');
                if (taskView) taskView.style.display = 'none';
                if (filteredView) filteredView.style.display = 'block';
            }
            
            const titleElement = document.getElementById('filtered-task-title');
            if (titleElement) {
                titleElement.textContent = 'All SLAs';
            }
            
            // Display all SLAs without filtering
            renderFilteredSLAs(null);
        }
        
        /**
         * Updates the SLA count badges on each task card in the task selection view.
         * Counts how many SLAs belong to each task (Task 1-9).
         * @returns {void}
         */
        function updateTaskCounts() {
            const slas = window.APP_DATA.slas || [];
            const taskCounts = {};
            
            // Initialize counts
            for (let i = 1; i <= 9; i++) {
                taskCounts[`Task ${i}`] = 0;
            }
            
            // Count SLAs per task (mapped from teamId)
            slas.forEach((sla, index) => {
                const teamId = sla.teamId;
                const taskName = window.TEAM_CONFIG.getTaskFromTeamId(teamId);
                
                if (taskName && taskCounts.hasOwnProperty(taskName)) {
                    taskCounts[taskName]++;
                }
            });
            
            // Update the UI
            for (let i = 1; i <= 9; i++) {
                const taskKey = `Task ${i}`;
                const count = taskCounts[taskKey];
                const countElement = document.getElementById(`task-${i}-count`);
                if (countElement) {
                    countElement.textContent = `${count} SLA${count !== 1 ? 's' : ''}`;
                }
            }
            
            // Update the all tasks count
            const totalCount = slas.length;
            const allTasksCountElement = document.getElementById('all-tasks-count');
            if (allTasksCountElement) {
                allTasksCountElement.textContent = `${totalCount} SLA${totalCount !== 1 ? 's' : ''}`;
            }
        }
        
        /**
         * Renders a filtered list of SLAs for a specific task in the filtered view table.
         * @param {string} taskName - Name of the task to filter by
         * @returns {void}
         */
        function renderFilteredSLAs(taskName) {
            const slas = window.APP_DATA.slas || [];
            
            // Filter SLAs by task name, or show all if taskName is null
            const filteredSLAs = taskName ? slas.filter(sla => {
                const teamId = sla.teamId;
                const slaTaskName = window.TEAM_CONFIG.getTaskFromTeamId(teamId);
                return slaTaskName === taskName;
            }) : slas;
            
            const tbody = document.getElementById('filtered-sla-table-body');
            
            if (!tbody) {
                console.error('Table body not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (filteredSLAs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-muted">
                            No SLAs found${taskName ? ` for ${taskName}` : ''}
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredSLAs.forEach(sla => {
                // Calculate progress if not already set (uses calculateProgress from utils.html)
                const progressPercent = calculateProgress(sla);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => viewSLADetails(sla.slaId);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-primary-color">${sla.slaName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${sla.slaType}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted">
                        ${getTeamName(sla.teamId) || 'Unknown Team'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadgeClass(sla.status)}">
                            ${sla.status.charAt(0).toUpperCase() + sla.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full ${getProgressBarClass(sla.status)}" style="width: ${progressPercent}%"></div>
                            </div>
                            <span class="text-sm text-muted">${progressPercent}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted">
                        ${formatDate(sla.endDate)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="event.stopPropagation(); viewSLADetails('${sla.slaId}')" class="text-primary-color hover:text-secondary-color mr-3">View</button>
                        <button onclick="event.stopPropagation(); viewSLADetails('${sla.slaId}'); setTimeout(() => enableInlineEditing('${sla.slaId}'), 100);" class="text-secondary-color hover:text-primary-color">Edit</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ========================================
        // SLA DETAIL AND CRUD OPERATIONS
        // ========================================

        /**
         * Shows the detail view for a specific SLA.
         * Sets the current SLA ID and renders its details.
         * @param {string} slaId - Unique identifier of the SLA to display
         * @returns {void}
         */
        function showSLADetail(slaId) {
            currentSlaId = slaId;
            renderSLADetail(slaId);
            showSection('detail');
        }

        /**
         * Alias function for showSLADetail() for consistency across the application.
         * @param {string} slaId - Unique identifier of the SLA to display
         * @returns {void}
         */
        function viewSLADetails(slaId) {
            showSLADetail(slaId);
        }

        /**
         * Deletes an SLA after user confirmation.
         * Removes from data array and refreshes the current view.
         * @param {string} slaId - Unique identifier of the SLA to delete
         * @returns {void}
         */
        function deleteSLA(slaId) {
            if (confirm('Are you sure you want to delete this SLA?')) {
                if (!window.APP_DATA || !window.APP_DATA.slas) {
                    console.error('No SLA data available for deletion');
                    return;
                }
                const index = window.APP_DATA.slas.findIndex(sla => sla.slaId === slaId);
                if (index > -1) {
                    window.APP_DATA.slas.splice(index, 1);
                    // Refresh the list section to update counts and views
                    showSection('list');
                    showNotification('SLA deleted successfully!');
                } else {
                    console.error('SLA not found for deletion:', slaId);
                }
            }
        }

        // ========================================
        // SLA FORM MANAGEMENT
        // ========================================

        /**
         * Adds a new SLA form tab to the create section.
         * Creates both the tab button and the form content.
         * @returns {void}
         */
        function addNewSLA() {
            slaCounter++;
            const slaContainer = document.getElementById('slaContainer');
            const tabsContainer = document.getElementById('slaTabs');
            const addButton = tabsContainer.querySelector('button[onclick="addNewSLA()"]');
            
            // Create tab HTML
            const tabHtml = `
                <button type="button" onclick="switchToTab(${slaCounter})" 
                        class="sla-tab"
                        id="tab-${slaCounter}">
                    <span>SLA ${slaCounter}</span>
                    <span onclick="event.stopPropagation(); removeSLATab(${slaCounter})" class="tab-close-btn">×</span>
                </button>
            `;
            
            // In edit mode, addButton won't exist, so just append to container
            if (addButton) {
                // Insert tab before the Add button (create mode)
                addButton.insertAdjacentHTML('beforebegin', tabHtml);
            } else {
                // No Add button (edit mode), just add to container
                tabsContainer.insertAdjacentHTML('beforeend', tabHtml);
            }
            
            // Create form container
            const slaHtml = createSLAForm(slaCounter);
            slaContainer.insertAdjacentHTML('beforeend', slaHtml);
            
            // Populate dropdowns
            populateTaskDropdown(slaCounter);
            populateParentSLADropdown(slaCounter);
            
            // Switch to the new tab
            switchToTab(slaCounter);
            
            // Initialize as invalid (no fields filled yet)
            updateTabValidation(slaCounter);
            
            // Show submit button at the top if this is the first SLA
            const topSubmitButton = document.getElementById('topSubmitButton');
            if (topSubmitButton) {
                topSubmitButton.style.display = 'block';
            }
        }

        // Note: populateParentSLADropdown is defined in scripts/form-builder.html
        // and exported globally

        /**
         * Switches to a specific SLA form tab.
         * Hides all other form containers and shows the selected one.
         * @param {string|number} id - Tab identifier
         * @returns {void}
         */
        function switchToTab(id) {
            // Hide all form containers
            document.querySelectorAll('.sla-form-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.sla-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected form container
            const targetContainer = document.getElementById(`sla-container-${id}`);
            if (targetContainer) {
                targetContainer.classList.add('active');
            }
            
            // Add active class to selected tab
            const targetTab = document.getElementById(`tab-${id}`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        /**
         * Removes an SLA form tab and its associated form container after confirmation.
         * Automatically switches to another tab if the removed tab was active.
         * @param {string|number} id - Tab identifier to remove
         * @returns {void}
         */
        function removeSLATab(id) {
            if (confirm('Are you sure you want to remove this SLA?')) {
                // Remove the tab
                const tab = document.getElementById(`tab-${id}`);
                if (tab) {
                    tab.remove();
                }
                
                // Remove the form container
                const container = document.getElementById(`sla-container-${id}`);
                if (container) {
                    container.remove();
                }
                
                // Switch to another tab if this was the active one
                const remainingTabs = document.querySelectorAll('.sla-tab');
                if (remainingTabs.length > 0) {
                    const lastTab = remainingTabs[remainingTabs.length - 1];
                    const tabId = lastTab.id.replace('tab-', '');
                    switchToTab(tabId);
                } else {
                    // Hide submit button if no tabs remain
                    const topSubmitButton = document.getElementById('topSubmitButton');
                    if (topSubmitButton) {
                        topSubmitButton.style.display = 'none';
                    }
                }
            }
        }

        /**
         * Updates the title text of an SLA form tab.
         * @param {string|number} id - Tab identifier
         * @param {string} title - New title for the tab
         * @returns {void}
         */
        function updateTabTitle(id, title) {
            const tab = document.getElementById(`tab-${id}`);
            if (tab) {
                const titleSpan = tab.querySelector('span');
                if (titleSpan) {
                    titleSpan.textContent = title || `SLA ${id}`;
                }
            }
        }

        /**
         * Attaches event listeners to automatically update tab titles when SLA name changes.
         * Also triggers validation updates on any form input change.
         * @returns {void}
         */
        function attachTabTitleListeners() {
            document.addEventListener('input', function(e) {
                if (e.target.id && e.target.id.startsWith('slaName-')) {
                    const id = e.target.id.replace('slaName-', '');
                    const title = e.target.value.trim() || `SLA ${id}`;
                    updateTabTitle(id, title);
                }
                
                // Update tab validation status on any input change
                if (e.target.closest('.sla-form-container')) {
                    const container = e.target.closest('.sla-form-container');
                    const tabId = container.id.replace('sla-container-', '');
                    updateTabValidation(tabId);
                }
            });
            
            // Also listen for select changes
            document.addEventListener('change', function(e) {
                if (e.target.closest('.sla-form-container')) {
                    const container = e.target.closest('.sla-form-container');
                    const tabId = container.id.replace('sla-container-', '');
                    updateTabValidation(tabId);
                }
            });
        }

        /**
         * Updates the visual validation status of an SLA form tab.
         * Adds 'valid' or 'invalid' class based on form validation results.
         * @param {string|number} tabId - Tab identifier to update
         * @returns {void}
         */
        function updateTabValidation(tabId) {
            const tab = document.getElementById(`tab-${tabId}`);
            const container = document.getElementById(`sla-container-${tabId}`);
            
            if (!tab || !container) return;
            
            const isValid = validateSLAForm(tabId);
            
            // Remove existing validation classes
            tab.classList.remove('valid', 'invalid');
            
            // Add appropriate validation class
            if (isValid) {
                tab.classList.add('valid');
            } else {
                tab.classList.add('invalid');
            }
        }

        /**
         * Validates that all required fields in an SLA form are filled.
         * Checks basic fields and type-specific configuration requirements.
         * @param {string|number} tabId - Tab identifier to validate
         * @returns {boolean} True if form is valid, false otherwise
         */
        function validateSLAForm(tabId) {
            const requiredFields = [
                `slaName-${tabId}`,
                `teamName-${tabId}`,
                `description-${tabId}`,
                `taskName-${tabId}`,
                `slaType-${tabId}`,
                `startDate-${tabId}`
            ];
            
            return requiredFields.every(fieldId => {
                const field = document.getElementById(fieldId);
                return field && field.value && field.value.trim() !== '';
            });
        }

        /**
         * Main form submission handler for all SLA forms.
         * Collects data from all tabs, validates, and processes submission.
         * Updates demoData, shows success notification, and navigates to list view.
         * @returns {void}
         */
        function submitSLAs() {
            // Collect all SLA data
            const slaData = collectSLAData();
            
            if (slaData.length === 0) {
                showNotification('Please create at least one SLA', 'error');
                return;
            }

            // Validate all SLAs have required fields
            const slaContainers = document.querySelectorAll('.sla-form-container');
            let hasInvalidSLAs = false;
            let invalidTabIds = [];

            slaContainers.forEach((container) => {
                const tabId = container.id.replace('sla-container-', '');
                if (!validateSLAForm(tabId)) {
                    hasInvalidSLAs = true;
                    invalidTabIds.push(tabId);
                }
            });

            if (hasInvalidSLAs) {
                showNotification('Please complete all required fields in all SLA tabs before submitting', 'error');
                
                // Highlight invalid tabs
                invalidTabIds.forEach(tabId => {
                    updateTabValidation(tabId);
                });
                
                // Switch to first invalid tab
                if (invalidTabIds.length > 0) {
                    switchToTab(invalidTabIds[0]);
                }
                return;
            }

            // Create new SLAs
            const payload = {
                timestamp: new Date().toISOString(),
                slas: slaData
            };

            console.log('SLA Data to be sent to backend:', JSON.stringify(payload, null, 2));
            
            // Submit to backend
            submitSLAsToBackend(payload.slas);
        }

        /**
         * Submits SLA data to backend for creation
         * @param {Array<Object>} slas - Array of SLA data objects
         * @returns {Promise<void>}
         */
        async function submitSLAsToBackend(slas) {
            try {
                console.log('=== submitSLAsToBackend START ===');
                console.log('SLAs to submit:', slas.length);
                
                // Show loading indicator
                showLoadingIndicator('Creating SLAs...');
                
                // Check if we're in GAS environment or local
                const isGasEnvironment = typeof google !== 'undefined' && google.script;
                
                if (!isGasEnvironment) {
                    // Local environment - show modal instead
                    console.log('Local environment detected - showing JSON modal');
                    hideLoadingIndicator();
                    showJsonModal({ timestamp: new Date().toISOString(), slas: slas });
                    showNotification('Local mode: SLAs not saved to backend');
                    return;
                }
                
                // Transform each SLA for backend
                console.log('Transforming SLAs for backend...');
                const transformedSLAs = slas.map(transformToBackendSchema);
                console.log('Transformed SLAs:', JSON.stringify(transformedSLAs[0], null, 2));
                
                // Call backend bulk create
                console.log('Calling SLA_API.bulkCreate...');
                const result = await SLA_API.bulkCreate(transformedSLAs);
                console.log('Backend result:', result);
                
                hideLoadingIndicator();
                
                if (result.success && result.errors.length === 0) {
                    // All SLAs created successfully
                    console.log('All SLAs created successfully:', result.created);
                    showNotification(`Successfully created ${result.created.length} SLA(s)!`);
                    
                    // Reload data from backend
                    console.log('Reloading SLAs from backend...');
                    await loadSLAsFromBackend();
                    
                    // Clear forms and reset
                    clearAllSLAForms();
                    
                    // Navigate to list view
                    setTimeout(() => {
                        showSection('list');
                    }, 1000);
                    
                } else if (result.success && result.errors.length > 0) {
                    // Partial success
                    console.warn('Partial success:', result);
                    showNotification(
                        `Created ${result.created.length} SLA(s). ${result.errors.length} failed.`, 
                        'warning'
                    );
                    
                    // Show details of failures
                    const errorDetails = result.errors.map(e => 
                        `SLA ${e.index + 1}: ${e.error}`
                    ).join('\n');
                    console.error('Creation errors:', errorDetails);
                    
                    // Reload to show successful ones
                    await loadSLAsFromBackend();
                    
                } else {
                    // Complete failure
                    console.error('Bulk create failed:', result);
                    console.error('Error details:', result.errors);
                    
                    // Extract error message from first error
                    let errorMessage = 'Unknown error';
                    if (result.errors && result.errors.length > 0) {
                        errorMessage = result.errors[0].error;
                        console.error('First error:', errorMessage);
                    }
                    
                    showNotification(`Failed to create SLAs: ${errorMessage}`, 'error');
                }
                
                console.log('=== submitSLAsToBackend END ===');
                
            } catch (error) {
                console.error('=== submitSLAsToBackend ERROR ===');
                console.error('Error:', error);
                hideLoadingIndicator();
                showNotification(`Error creating SLAs: ${error.message || error.toString()}`, 'error');
            }
        }

        /**
         * Clears all SLA forms and resets the form state
         * @returns {void}
         */
        function clearAllSLAForms() {
            // Remove all tabs except the first one
            const tabsContainer = document.getElementById('slaTabs');
            const tabs = tabsContainer.querySelectorAll('.sla-tab:not(:first-child):not(:last-child)');
            tabs.forEach(tab => tab.remove());
            
            // Remove all form containers except the first one
            const formsContainer = document.getElementById('slaContainer');
            const forms = formsContainer.querySelectorAll('.sla-form-container:not(:first-child)');
            forms.forEach(form => form.remove());
            
            // Reset the first form
            const firstForm = formsContainer.querySelector('.sla-form-container:first-child');
            if (firstForm) {
                const formId = firstForm.id.replace('sla-container-', '');
                const form = firstForm.querySelector('form');
                if (form) {
                    form.reset();
                }
                // Clear any email chips
                const emailDisplay = document.getElementById(`emailChipsDisplay-${formId}`);
                if (emailDisplay) {
                    emailDisplay.innerHTML = '';
                }
            }
            
            // Reset counter
            slaCounter = 1;
            
            console.log('All SLA forms cleared');
        }

        /**
         * Collects SLA data from all form containers.
         * Validates each SLA before adding to array.
         * @returns {Array<Object>} Array of SLA data objects extracted from forms
         */
        function collectSLAData() {
            const slaDataArray = [];
            const validationErrors = [];
            
            // Collect data from all SLA forms in their containers
            const slaContainers = document.querySelectorAll('.sla-form-container');
            
            slaContainers.forEach((container, index) => {
                const slaData = extractSLADataFromContainer(container);
                if (slaData) {
                    // Validate the data
                    const validation = validateSLAData(slaData);
                    if (!validation.isValid) {
                        validationErrors.push({
                            slaName: slaData.slaName,
                            errors: validation.errors
                        });
                    } else {
                        slaData.id = 'SLA-' + String(Date.now() + index).padStart(6, '0');
                        slaDataArray.push(slaData);
                    }
                }
            });
            
            // Show validation errors if any
            if (validationErrors.length > 0) {
                let errorMessage = 'Validation errors found:\n';
                validationErrors.forEach(ve => {
                    errorMessage += `\n${ve.slaName}:\n- ${ve.errors.join('\n- ')}\n`;
                });
                showNotification(errorMessage, 'error');
            }
            
            return slaDataArray;
        }

        // Note: extractSLADataFromContainer and validateSLAData functions
        // are now defined in scripts/form-builder.html and exported globally

        /**
         * Updates the hidden team_id field when a team name is selected.
         * Uses TEAM_CONFIG for team ID lookup.
         * @param {string|number} id - Form identifier
         * @param {string} teamName - Name of the selected team
         * @returns {void}
         */
        function updateTeamId(id, teamName) {
            const teamIdField = document.getElementById(`teamId-${id}`);
            if (teamIdField && teamName) {
                teamIdField.value = window.TEAM_CONFIG.getTeamId(teamName) || '';
            }
        }

        /**
         * Updates team dropdown options based on the selected task.
         * Maps tasks to their corresponding team members with validation.
         * @param {string|number} id - Form identifier
         * @param {string} selectedTask - Name of the selected task
         * @returns {void}
         */
        function updateTeamOptions(id, selectedTask) {
            if (!id || !selectedTask) {
                console.warn('updateTeamOptions: Invalid parameters', { id, selectedTask });
                return;
            }
            
            const teamSelect = document.getElementById(`teamName-${id}`);
            if (!teamSelect) {
                console.error(`Team select element not found for ID: teamName-${id}`);
                return;
            }
            
            // Clear existing options
            teamSelect.innerHTML = '<option value="">Select Team</option>';
            
            // Get teams from TEAM_CONFIG
            const teamObjects = window.TEAM_CONFIG.getTeamsForTask(selectedTask);
            
            if (teamObjects && teamObjects.length > 0) {
                teamObjects.forEach(teamObj => {
                    const option = document.createElement('option');
                    option.value = teamObj.name;
                    option.textContent = teamObj.name;
                    teamSelect.appendChild(option);
                });
                
                // Auto-select if only one team option (Tasks 1, 3-9)
                if (teamObjects.length === 1) {
                    teamSelect.value = teamObjects[0].name;
                    // Trigger change event for any dependent functionality
                    teamSelect.dispatchEvent(new Event('change'));
                }
            }
        }

        /**
         * Handles keyboard input for email chip functionality.
         * Adds email chip when user presses Enter or comma.
         * @param {Event} event - Keyboard event
         * @param {string|number} formId - Form identifier
         * @returns {void}
         */
        function handleEmailInputKey(event, formId) {
            const input = event.target;
            const key = event.key;
            
            // Add email on Enter or comma
            if (key === 'Enter' || key === ',') {
                event.preventDefault();
                addEmailFromInput(formId);
            }
            // Remove last chip on Backspace if input is empty
            else if (key === 'Backspace' && input.value === '') {
                const display = document.getElementById(`emailChipsDisplay-${formId}`);
                const chips = display.querySelectorAll('.email-chip');
                if (chips.length > 0) {
                    chips[chips.length - 1].remove();
                    updateHiddenEmailField(formId);
                }
            }
        }

        /**
         * Adds email from input field as a chip.
         * Validates email format before adding.
         * @param {string|number} formId - Form identifier
         * @returns {void}
         */
        function addEmailFromInput(formId) {
            const input = document.getElementById(`notificationEmailInput-${formId}`);
            const email = input.value.trim().replace(/,/g, '');
            
            if (email && validateEmail(email)) {
                addEmailChip(formId, email);
                input.value = '';
                updateHiddenEmailField(formId);
            } else if (email) {
                showNotification('Please enter a valid email address', 'error');
            }
        }

        // Note: validateEmail moved to scripts/utils.html

        /**
         * Adds an email chip to the display area.
         * Creates a visual chip element with remove button and theme-aware styling.
         * @param {string|number} formId - Form identifier
         * @param {string} email - Email address to add
         * @returns {void}
         */
        function addEmailChip(formId, email) {
            const display = document.getElementById(`emailChipsDisplay-${formId}`);
            
            // Check if email already exists
            const existingChips = display.querySelectorAll('.email-chip');
            for (let chip of existingChips) {
                if (chip.dataset.email === email) {
                    showNotification('Email already added', 'error');
                    return;
                }
            }
            
            const chip = document.createElement('span');
            chip.className = 'email-chip inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm border transition-colors';
            chip.style.cssText = 'background-color: var(--color-primary); border-color: var(--color-primary); color: white;';
            chip.dataset.email = email;
            chip.innerHTML = `
                <span>${email}</span>
                <button type="button" onclick="removeEmailChip(${formId}, '${email}')" 
                        class="hover:bg-white hover:bg-opacity-20 rounded-full p-0.5 transition-colors flex items-center justify-center"
                        style="width: 16px; height: 16px;">
                    <i class="bi bi-x text-base leading-none"></i>
                </button>
            `;
            
            display.appendChild(chip);
        }

        /**
         * Removes an email chip from the display area.
         * @param {string|number} formId - Form identifier
         * @param {string} email - Email address to remove
         * @returns {void}
         */
        function removeEmailChip(formId, email) {
            const display = document.getElementById(`emailChipsDisplay-${formId}`);
            const chips = display.querySelectorAll('.email-chip');
            
            chips.forEach(chip => {
                if (chip.dataset.email === email) {
                    chip.remove();
                }
            });
            
            updateHiddenEmailField(formId);
        }

        /**
         * Updates the hidden email field with all chip emails as comma-separated string.
         * @param {string|number} formId - Form identifier
         * @returns {void}
         */
        function updateHiddenEmailField(formId) {
            const display = document.getElementById(`emailChipsDisplay-${formId}`);
            const chips = display.querySelectorAll('.email-chip');
            const emails = Array.from(chips).map(chip => chip.dataset.email);
            
            const hiddenField = document.getElementById(`notificationEmail-${formId}`);
            if (hiddenField) {
                hiddenField.value = emails.join(',');
            }
        }

        /**
         * Shows the appropriate configuration panel based on SLA type.
         * Hides all other configuration panels and displays only the relevant one.
         * @param {string|number} id - Form identifier
         * @param {string} type - SLA type ('timeliness', 'quality', 'availability', 'quantity', 'percentage', 'compliance')
         * @returns {void}
         */
        function showSLAConfig(id, type) {
            const slaConfigSection = document.getElementById(`slaConfig-${id}`);
            const allConfigs = document.querySelectorAll(`#sla-${id} .sla-config-section`);
            
            // Check if elements exist before accessing them
            if (!slaConfigSection) {
                console.warn(`SLA config section not found for ID: ${id}`);
                return;
            }
            
            // Hide all config sections
            allConfigs.forEach(config => config.classList.add('hidden'));
            
            if (type) {
                slaConfigSection.classList.remove('hidden');
                const targetConfig = document.getElementById(`${type}Config-${id}`);
                if (targetConfig) {
                    targetConfig.classList.remove('hidden');
                }
            } else {
                slaConfigSection.classList.add('hidden');
            }
        }

/**
 * Toggles between single value and range inputs for quantity SLA targets.
 * Shows min/max fields if range is checked, single target field otherwise.
 * @param {string|number} id - Form identifier
 * @returns {void}
 */
function toggleQuantityRange(id) {
    const checkbox = document.getElementById(`quantityRange-${id}`);
    const targetDiv = document.getElementById(`quantityTarget-${id}`);
    
    if (!checkbox || !targetDiv) return;
    
    const isRange = checkbox.checked;
    
    if (isRange) {
        targetDiv.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-primary-color mb-2">Minimum Value</label>
                <input type="number" placeholder="Minimum Value" class="w-full px-3 py-2 border border-color rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-primary-color mb-2">Maximum Value</label>
                <input type="number" placeholder="Maximum Value" class="w-full px-3 py-2 border border-color rounded-md">
            </div>
        `;
        targetDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-4';
    } else {
        targetDiv.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-primary-color mb-2">Target Value</label>
                <input type="number" id="quantityTargetValue-${id}" class="w-full px-3 py-2 border border-color rounded-md">
            </div>
        `;
        targetDiv.className = 'grid grid-cols-1 gap-4 mb-4';
    }
}

/**
 * Toggles between single value and range inputs for percentage SLA targets.
 * Shows min/max percentage fields if range is checked, single target field otherwise.
 * @param {string|number} id - Form identifier
 * @returns {void}
 */
function togglePercentageRange(id) {
    const checkbox = document.getElementById(`percentageRange-${id}`);
    const targetDiv = document.getElementById(`percentageTarget-${id}`);
    
    if (!checkbox || !targetDiv) return;
    
    const isRange = checkbox.checked;
    
    if (isRange) {
        targetDiv.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-primary-color mb-2">Minimum Percentage</label>
                <input type="number" placeholder="Minimum Percentage" min="0" max="100" step="0.01" class="w-full px-3 py-2 border border-color rounded-md">
            </div>
            <div>
                <label class="block text-sm font-medium text-primary-color mb-2">Maximum Percentage</label>
                <input type="number" placeholder="Maximum Percentage" min="0" max="100" step="0.01" class="w-full px-3 py-2 border border-color rounded-md">
            </div>
        `;
        targetDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mt-4';
    } else {
        targetDiv.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-primary-color mb-2">Target Percentage</label>
                <input type="number" id="percentageTargetValue-${id}" min="0" max="100" step="0.01" class="w-full px-3 py-2 border border-color rounded-md">
            </div>
        `;
        targetDiv.className = 'grid grid-cols-1 gap-4 mt-4';
    }
}

        /**
         * Adds a new child SLA form to a parent SLA configuration.
         * Creates a nested SLA entry with target and description fields.
         * @param {string|number} parentId - Parent SLA form identifier
         * @returns {void}
         */
        function addChildSLA(parentId) {
            const container = document.getElementById(`childSLAContainer-${parentId}`);
            const childId = `${parentId}-${Date.now()}`;
            const childHtml = `
                <div id="childSLA-${childId}" class="bg-surface p-4 rounded-md border border-color">
                    <div class="flex items-center justify-between mb-3">
                        <h6 class="text-sm font-medium text-primary-color">Child SLA</h6>
                        <button type="button" onclick="removeChildSLA('${childId}')" class="text-xs" style="color: var(--color-status-error)">Remove</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-primary-color mb-1">Target Value</label>
                            <input type="number" class="w-full px-2 py-1 border border-color rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-primary-color mb-1">Unit Description</label>
                            <input type="text" placeholder="e.g., documents per package" class="w-full px-2 py-1 border border-color rounded text-sm">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', childHtml);
        }

        /**
         * Removes a child SLA form from the parent configuration.
         * @param {string} childId - Child SLA identifier to remove
         * @returns {void}
         */
        function removeChildSLA(childId) {
            const childElement = document.getElementById(`childSLA-${childId}`);
            if (childElement) {
                childElement.remove();
            }
        }

        /**
         * Alias function for removeSLATab() for consistency.
         * @param {string|number} id - SLA/tab identifier to remove
         * @returns {void}
         */
        function removeSLA(id) {
            removeSLATab(id);
        }

        // ========================================
        // MODAL MANAGEMENT
        // ========================================

        /**
         * Shows the update/status change modal for an SLA.
         * @returns {void}
         */
        /**
         * Shows the type-specific update modal based on current SLA type.
         * Populates the modal with current SLA data.
         * @returns {void}
         */
        function showUpdateModal() {
            const slaData = window.APP_DATA?.slas || [];
            const sla = slaData.find(s => s.slaId === currentSlaId);
            
            if (!sla) {
                showNotification('SLA not found', 'error');
                return;
            }
            
            // Backend returns camelCase - use it directly
            const slaType = sla.slaType;
            const currentValue = sla.currentValue !== undefined ? sla.currentValue : 0;
            const customFields = getCustomFields(sla);
            
            // Show the appropriate modal based on SLA type
            const modalId = `updateModal-${slaType}`;
            const modal = document.getElementById(modalId);
            
            if (!modal) {
                console.warn(`No modal found for type: ${slaType}, using generic modal`);
                showNotification(`Update modal for ${slaType} not implemented`, 'error');
                return;
            }
            
            // Populate modal fields based on type
            switch (slaType) {
                case 'quantity':
                    document.getElementById('updateQuantityValue').value = currentValue || 0;
                    document.getElementById('updateQuantityNotes').value = '';
                    break;
                    
                case 'percentage':
                    document.getElementById('updatePercentageValue').value = currentValue || 0;
                    document.getElementById('updatePercentageNotes').value = '';
                    break;
                    
                case 'timeliness':
                    const now = new Date();
                    document.getElementById('updateTimelinessDate').value = now.toISOString().split('T')[0];
                    document.getElementById('updateTimelinessTime').value = now.toTimeString().substring(0, 5);
                    document.getElementById('updateTimelinessNotes').value = '';
                    break;
                    
                case 'availability':
                    document.getElementById('updateAvailabilityValue').value = currentValue || 99.9;
                    document.getElementById('updateAvailabilityDowntime').value = 0;
                    document.getElementById('updateAvailabilityNotes').value = '';
                    break;
                    
                case 'compliance':
                    const isCompliant = currentValue === true || currentValue === 1 || currentValue === 'true';
                    document.getElementById('updateComplianceStatus').value = isCompliant ? 'true' : 'false';
                    document.getElementById('updateComplianceNotes').value = '';
                    break;
                    
                case 'composite':
                    document.getElementById('updateCompositeScore').value = currentValue || 0;
                    document.getElementById('updateCompositeNotes').value = '';
                    break;
                    
                case 'multi-metric':
                    document.getElementById('updateMultiMetricScore').value = currentValue || 0;
                    document.getElementById('updateMultiMetricNotes').value = '';
                    break;
                    
                case 'recurring':
                    document.getElementById('updateRecurringValue').value = currentValue || 0;
                    document.getElementById('updateRecurringNotes').value = '';
                    break;
            }
            
            modal.classList.remove('hidden');
        }

        /**
         * Hides all update modals.
         * @returns {void}
         */
        function hideUpdateModal() {
            const modals = document.querySelectorAll('.update-modal');
            modals.forEach(modal => modal.classList.add('hidden'));
        }

/**
 * Saves the SLA update from the type-specific modal form.
 * Updates current value, recalculates progress, adds activity log entry.
 * @returns {void}
 */
async function saveUpdate() {
    const slaData = window.APP_DATA?.slas || [];
    const sla = slaData.find(s => s.slaId === currentSlaId);
    
    if (!sla) {
        showNotification('SLA not found', 'error');
        return;
    }
    
    // Backend returns camelCase - use it directly
    const slaType = sla.slaType;
    let newValue;
    let notes = '';
    let updateMessage = '';
    let customFieldsUpdate = {};
    
    // Get values based on SLA type
    switch (slaType) {
        case 'quantity':
            newValue = parseFloat(document.getElementById('updateQuantityValue').value);
            notes = document.getElementById('updateQuantityNotes').value;
            if (isNaN(newValue)) {
                showNotification('Please enter a valid quantity', 'error');
                return;
            }
            updateMessage = `Quantity updated to ${newValue}`;
            break;
            
        case 'percentage':
            newValue = parseFloat(document.getElementById('updatePercentageValue').value);
            notes = document.getElementById('updatePercentageNotes').value;
            if (isNaN(newValue) || newValue < 0 || newValue > 100) {
                showNotification('Please enter a valid percentage (0-100)', 'error');
                return;
            }
            updateMessage = `Percentage updated to ${newValue}%`;
            break;
            
        case 'timeliness':
            const completionDate = document.getElementById('updateTimelinessDate').value;
            const completionTime = document.getElementById('updateTimelinessTime').value;
            notes = document.getElementById('updateTimelinessNotes').value;
            
            if (!completionDate) {
                showNotification('Please select a completion date', 'error');
                return;
            }
            
            const completionDateTime = completionTime ? 
                `${completionDate}T${completionTime}:00Z` : 
                `${completionDate}T12:00:00Z`;
            
            newValue = completionDateTime;
            updateMessage = `Completed on ${completionDate}${completionTime ? ' at ' + completionTime : ''}`;
            
            // Update custom fields
            customFieldsUpdate.lastCompletion = completionDateTime;
            break;
            
        case 'availability':
            newValue = parseFloat(document.getElementById('updateAvailabilityValue').value);
            const downtime = parseFloat(document.getElementById('updateAvailabilityDowntime').value) || 0;
            notes = document.getElementById('updateAvailabilityNotes').value;
            
            if (isNaN(newValue) || newValue < 0 || newValue > 100) {
                showNotification('Please enter a valid uptime percentage (0-100)', 'error');
                return;
            }
            updateMessage = `Uptime updated to ${newValue}%${downtime > 0 ? ` (${downtime} min downtime)` : ''}`;
            
            if (downtime > 0) {
                customFieldsUpdate.lastDowntime = downtime;
                customFieldsUpdate.lastDowntimeDate = new Date().toISOString();
            }
            break;
            
        case 'compliance':
            const complianceStatus = document.getElementById('updateComplianceStatus').value;
            notes = document.getElementById('updateComplianceNotes').value;
            newValue = complianceStatus === 'true' ? 1 : 0;
            updateMessage = `Compliance status: ${complianceStatus === 'true' ? 'Compliant' : 'Not Compliant'}`;
            break;
            
        case 'composite':
            newValue = parseFloat(document.getElementById('updateCompositeScore').value);
            notes = document.getElementById('updateCompositeNotes').value;
            if (isNaN(newValue)) {
                showNotification('Please enter a valid score', 'error');
                return;
            }
            updateMessage = `Composite score updated to ${newValue}`;
            break;
            
        case 'multi-metric':
            newValue = parseFloat(document.getElementById('updateMultiMetricScore').value);
            notes = document.getElementById('updateMultiMetricNotes').value;
            if (isNaN(newValue)) {
                showNotification('Please enter a valid score', 'error');
                return;
            }
            updateMessage = `Multi-metric score updated to ${newValue}`;
            break;
            
        case 'recurring':
            newValue = parseFloat(document.getElementById('updateRecurringValue').value);
            notes = document.getElementById('updateRecurringNotes').value;
            if (isNaN(newValue)) {
                showNotification('Please enter a valid value', 'error');
                return;
            }
            updateMessage = `Period value updated to ${newValue}`;
            break;
            
        default:
            showNotification('Unknown SLA type', 'error');
            return;
    }
    
    // Prepare update object for backend
    const oldValue = sla.currentValue !== undefined ? sla.currentValue : 0;
    
    // Recalculate progress based on new value
    const targetValue = sla.targetValue !== undefined ? sla.targetValue : 0;
    const newProgress = targetValue > 0 ? Math.min(100, Math.round((newValue / targetValue) * 100)) : 0;
    
    // Update status based on new progress (simple logic)
    let newStatus = sla.status;
    if (newProgress >= 100) {
        newStatus = 'met';
    } else if (newProgress >= 80) {
        newStatus = 'ontrack';
    } else if (newProgress >= 50) {
        newStatus = 'at-risk';
    } else {
        newStatus = 'missed';
    }
    
    // Add update notes to custom fields if provided
    const customFields = getCustomFields(sla);
    if (notes) {
        customFieldsUpdate.lastUpdateNotes = notes;
        customFieldsUpdate.lastUpdateTime = new Date().toISOString();
        updateMessage += ` - ${notes}`;
    }
    
    // Merge custom fields
    const mergedCustomFields = { ...customFields, ...customFieldsUpdate };
    
    // Prepare updates object for backend
    const updates = {
        currentValue: newValue,
        progress: newProgress,
        status: newStatus,
        customFields: mergedCustomFields,
        rowVersion: sla.rowVersion || 0
    };
    
    console.log('Sending update to backend:', updates);
    
    // Call backend to persist changes
    if (typeof updateSLAInBackend === 'function') {
        hideUpdateModal();
        
        updateSLAInBackend(currentSlaId, updates).then(success => {
            if (success) {
                console.log('Backend update successful:', updateMessage);
                // Backend function already handles data refresh and UI update
            } else {
                // Update failed, but keep modal closed and show error via notification
                console.error('Backend update failed');
            }
        }).catch(error => {
            console.error('Error calling backend:', error);
            showNotification('Error updating progress: ' + error.message, 'error');
        });
    } else {
        // Fallback: update local data only if backend function not available
        console.warn('updateSLAInBackend not available, updating local data only');
        
        sla.currentValue = newValue;
        sla.progress = newProgress;
        sla.status = newStatus;
        
        // Update audit fields
        const now = new Date().toISOString();
        if (sla.last_updated_at !== undefined) {
            sla.last_updated_at = now;
            sla.last_updated_by = window.APP_DATA.userData?.employeeId || 'UNKNOWN';
        } else {
            sla.updatedAt = now;
            sla.updatedBy = window.APP_DATA.userData?.employeeId || 'UNKNOWN';
        }
        
        // Update custom fields in local data
        if (Object.keys(customFieldsUpdate).length > 0) {
            if (sla.custom_fields_json) {
                const cf = JSON.parse(sla.custom_fields_json);
                Object.assign(cf, customFieldsUpdate);
                sla.custom_fields_json = JSON.stringify(cf);
            } else if (sla.customFields) {
                const cf = typeof sla.customFields === 'string' ? JSON.parse(sla.customFields) : sla.customFields;
                Object.assign(cf, customFieldsUpdate);
                sla.customFields = JSON.stringify(cf);
            }
        }
        
        console.log('SLA updated locally:', updateMessage);
        
        // Re-render the detail page with updated data
        renderSLADetail(currentSlaId);
        
        // Update dashboard and list if needed
        if (typeof updateDashboardStats === 'function') updateDashboardStats();
        if (typeof updateDashboardRecentSLAs === 'function') updateDashboardRecentSLAs();
        
        showNotification('Progress updated successfully!');
        hideUpdateModal();
    }
}

        // ========================================
        // NOTIFICATION AND UI FEEDBACK
        // ========================================

        /**
         * Shows a toast notification message to the user.
         * Automatically hides after 3 seconds. Includes XSS protection.
         * @param {string} message - Message to display
         * @param {string} [type='success'] - Notification type ('success' or 'error')
         * @returns {void}
         */
        function showNotification(message, type = 'success') {
            const notification = domCache.notification || document.getElementById('notification');
            if (!notification) return;
            
            // Sanitize message to prevent XSS
            notification.textContent = String(message).slice(0, 200); // Limit length
            
            const bgColor = type === 'success' ? 'var(--color-status-success)' : 'var(--color-status-error)';
            notification.style.backgroundColor = bgColor;
            notification.style.color = 'white';
            notification.classList.remove('hidden');
            
            // Clear any existing timeout
            if (notification.timeoutId) {
                clearTimeout(notification.timeoutId);
            }
            
            // Auto-hide after 3 seconds
            notification.timeoutId = setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

// Backend configuration
const BACKEND_CONFIG = {
    BASE_URL: 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE',
    GET_SLAS_ENDPOINT: 'YOUR_WEB_APP_URL?action=getAllSLAs'
};

/**
 * Load SLAs from backend
 */
// REMOVED: Old loadSLAsFromBackend() function that used fetch() - replaced by version in backend-integration.html that uses google.script.run

/**
 * Refresh data from backend
 */
async function refreshDataFromBackend() {
    const success = await loadSLAsFromBackend();
    if (success) {
        // Re-render current section
        const currentSection = document.querySelector('.section.active')?.id;
        if (currentSection) {
            showSection(currentSection);
        }
    }
}

// REMOVED: Orphaned addRefreshButton() function (never called)
// If refresh functionality is needed in the future, it can be re-implemented
// and called during initialization

        /**
         * Loads application data from separate data files when running locally.
         * Fetches metadata, SLAs, and user data files sequentially and consolidates them.
         * Used as fallback when include() scriptlets may not work.
         * @returns {Promise<boolean>} True if data loaded successfully
         */
        function loadApplicationDataFallback() {
            return new Promise(async (resolve) => {
                const baseUrl = new URL('.', window.location.href).href;
                const dataFiles = ['data/metadata.html', 'data/slas.html', 'data/user.html', 'data/app-data.html'];
                
                // Load all data files sequentially to ensure proper initialization order
                for (const file of dataFiles) {
                    try {
                        const response = await fetch(baseUrl + file);
                        if (!response.ok) {
                            throw new Error('Failed to fetch ' + file + ': ' + response.status);
                        }
                        const html = await response.text();
                        
                        // Extract and execute script content
                        const match = html.match(/<script>([\s\S]*?)<\/script>/i);
                        if (match && match[1]) {
                            try {
                                eval(match[1]);
                                console.log('Loaded data from ' + file);
                            } catch (e) {
                                console.error('Error executing script from ' + file + ':', e);
                            }
                        }
                    } catch (error) {
                        console.warn('Could not load ' + file + ':', error);
                    }
                }
                
                // After all files are loaded sequentially, consolidate the data
                if (typeof APP_DATA !== 'undefined' && APP_DATA) {
                    // Transform snake_case data to camelCase to match backend API
                    const rawSlas = APP_DATA.demoData?.slas || [];
                    window.APP_DATA.slas = rawSlas.map(sla => ({
                        ...sla,
                        slaId: sla.sla_id || sla.slaId,
                        parentId: sla.parent_id || sla.parentId,
                        slaName: sla.sla_name || sla.slaName,
                        slaType: sla.sla_type || sla.slaType,
                        teamId: sla.team_id || sla.teamId,
                        startDate: sla.start_date || sla.startDate,
                        endDate: sla.end_date || sla.endDate,
                        currentValue: sla.current_value !== undefined ? sla.current_value : sla.currentValue,
                        targetValue: sla.target_value !== undefined ? sla.target_value : sla.targetValue,
                        notificationEmails: sla.notification_emails || sla.notificationEmails,
                        externalTrackerUrl: sla.external_tracker_url || sla.externalTrackerUrl,
                        customFieldsJson: sla.custom_fields_json || sla.customFieldsJson,
                        isActive: sla.is_active !== undefined ? sla.is_active : sla.isActive,
                        createdAt: sla.created_at || sla.createdAt,
                        createdBy: sla.created_by || sla.createdBy,
                        updatedAt: sla.updated_at || sla.last_updated_at || sla.updatedAt,
                        updatedBy: sla.updated_by || sla.last_updated_by || sla.updatedBy,
                        rowVersion: sla.row_version !== undefined ? sla.row_version : sla.rowVersion
                    }));
                    
                    // Also update window.SLA_DATA.slas to keep it in sync (for backward compatibility)
                    // This ensures any code checking window.SLA_DATA will get the transformed data
                    if (window.SLA_DATA) {
                        window.SLA_DATA.slas = window.APP_DATA.slas;
                    }
                    
                    window.APP_DATA.userData = APP_DATA.userData || null;
                    window.APP_DATA.isDemo = true;
                    window.APP_DATA.source = 'demo';
                    if (window.APP_DATA.slas && window.APP_DATA.slas.length > 0) {
                        console.log('✅ Application data loaded successfully, total ' + window.APP_DATA.slas.length + ' SLAs (camelCase)');
                    }
                    resolve(true);
                } else {
                    console.error('APP_DATA not properly initialized after loading all data files');
                    resolve(false);
                }
            });
        }

        // Form Management
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize APP_DATA structure if not already injected by server
            window.APP_DATA = window.APP_DATA || {
                slas: [],
                userData: null,
                isDemo: false,
                source: 'unknown'
            };
            
            // Check if we're in local environment and need to wait for scripts
            const isGasEnvironment = typeof google !== 'undefined' && google.script;
            
            if (!isGasEnvironment) {
                // Local environment - wait for scripts to load
                console.log('🔧 Local environment - waiting for scripts to load...');
                
                // Wait for scripts to be loaded
                await new Promise((resolve) => {
                    if (typeof enableInlineEditing !== 'undefined') {
                        // Scripts already loaded
                        resolve();
                    } else {
                        // Wait for scriptsLoaded event
                        window.addEventListener('scriptsLoaded', resolve, { once: true });
                        
                        // Timeout after 5 seconds
                        setTimeout(() => {
                            console.warn('⚠️ Script loading timeout - continuing anyway');
                            resolve();
                        }, 5000);
                    }
                });
            }
            
            // Initialize theme first
            initializeTheme();

            // Initialize TEAM_CONFIG
            console.log('🔧 Initializing TEAM_CONFIG...');
            try {
                await window.TEAM_CONFIG.initialize();
                console.log('✅ TEAM_CONFIG initialized successfully');
            } catch (error) {
                console.error('❌ Failed to initialize TEAM_CONFIG:', error);
            }

            // Initialize profile display
            updateProfileDisplay();
            
            // Check if we have server-injected data
            if (window.APP_DATA.source === 'server-injection' && window.APP_DATA.slas && window.APP_DATA.slas.length > 0) {
                console.log('✅ Using server-injected data:', {
                    slaCount: window.APP_DATA.slas.length,
                    userData: window.APP_DATA.userData?.email,
                    injectedAt: window.APP_DATA.injectedAt
                });
                
                // Initialize UI with injected data immediately
                updateDashboardStats();
                updateDashboardRecentSLAs();
                updateTaskCounts();
                
                // NOTE: Periodic refresh removed - only manual refresh via button
                console.log('✅ Data loaded. Use refresh button for manual updates.');
                
            } else if (!isGasEnvironment) {
                // Local environment - fetch application data from separate files
                console.log('Not in GAS environment, loading demo data from data folder');
                window.APP_DATA.source = 'demo';
                window.APP_DATA.isDemo = true;
                await loadApplicationDataFallback();
            } else if (isGasEnvironment) {
                // GAS environment but no server injection - fallback to backend call
                console.log('GAS environment detected but no server injection, loading from backend...');
                window.APP_DATA.source = 'backend';
                window.APP_DATA.isDemo = false;
                await loadSLAsFromBackend();
            }
            
            // Initialize UI with loaded data (if not already done)
            if (window.APP_DATA.source !== 'server-injection') {
                updateDashboardStats();
                updateDashboardRecentSLAs();
            }

            // Add initial SLA form
            addNewSLA();
            
            // Initialize tab title listeners
            attachTabTitleListeners();
                    
            // Handle form submission
            const createSlaForm = document.getElementById('createSlaForm');
            if (createSlaForm) {
                // Update your form submission handler
                // createSlaForm.addEventListener('submit', async function(e) {
                //     e.preventDefault();
                    
                //     const slaData = collectSLAData();
                    
                //     if (slaData.length === 0) {
                //         showNotification('Please create and save at least one SLA', 'error');
                //         return;
                //     }

                //     const payload = {
                //         timestamp: new Date().toISOString(),
                //         slaCount: slaData.length,
                //         slas: slaData
                //     };

                //     // Show JSON for demo (keep this)
                //     console.log('SLA Data to be sent to backend:', JSON.stringify(payload, null, 2));
                //     showJsonModal(payload);
                    
                //     // Actually submit to backend
                //     const success = await submitToBackend(payload);
                    
                //     if (success) {
                //         showNotification('All SLAs processed successfully!');
                //         setTimeout(() => {
                //             showSection('list');
                //         }, 2000);
                //     }
                // });


                // Modify the existing form submission handler
                createSlaForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitSLAs();
                });
            }

            // Add search and filter functionality
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const priorityFilter = document.getElementById('priorityFilter');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    showNotification('Search functionality would filter results here');
                });
            }

            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    showNotification('Status filter applied');
                });
            }

            if (priorityFilter) {
                priorityFilter.addEventListener('change', function() {
                    showNotification('Priority filter applied');
                });
            }
        });

// Add this function to handle backend submission
async function submitToBackend(payload) {
    const BACKEND_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';
    
    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Successfully saved ${result.data.processedCount} SLAs to Google Sheets!`);
            return true;
        } else {
            showNotification(`Error: ${result.message}`, 'error');
            return false;
        }
    } catch (error) {
        console.error('Backend submission error:', error);
        showNotification('Failed to save to backend. Check console for details.', 'error');
        return false;
    }
}


        /**
         * Shows a modal displaying the JSON payload that would be sent to backend.
         * Includes syntax highlighting and copy-to-clipboard functionality.
         * @param {Object} payload - The data payload to display as JSON
         * @returns {void}
         */
        function showJsonModal(payload) {
            // Create and show modal with JSON data
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-surface rounded-lg p-6 w-full max-w-4xl mx-4 max-h-96 overflow-y-auto';
            
            modalContent.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-primary-color">JSON Payload (Ready for Backend)</h3>
                    <button class="close-modal text-secondary-color hover:text-primary-color">✕</button>
                </div>
                <pre class="bg-gray-100 p-4 rounded-md text-sm overflow-x-auto">${JSON.stringify(payload, null, 2)}</pre>
                <div class="flex justify-end space-x-3 mt-4">
                    <button class="copy-json px-4 py-2 rounded-md btn-secondary">Copy JSON</button>
                    <button class="close-modal px-4 py-2 rounded-md btn-primary">Close</button>
                </div>
            `;
            
            // Add secure event listeners instead of onclick
            modalContent.querySelector('.copy-json').addEventListener('click', () => {
                copyToClipboard(JSON.stringify(payload));
            });
            
            modalContent.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => modal.remove());
            });
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // ========================================
        // THEME MANAGEMENT
        // ========================================

        /**
         * Initializes the theme system on page load.
         * Loads saved theme preference from localStorage and applies it.
         * @returns {void}
         */
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                if (themeIcon) themeIcon.className = 'bi bi-moon text-lg text-secondary-color';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                if (themeIcon) themeIcon.className = 'bi bi-sun text-lg text-secondary-color';
            }
        }

        /**
         * Toggles between light and dark theme modes.
         * Saves preference to localStorage and updates theme icon.
         * @returns {void}
         */
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme icon
            const themeIcon = document.getElementById('themeIcon');
            if (newTheme === 'dark') {
                themeIcon.className = 'bi bi-moon text-lg text-secondary-color';
            } else {
                themeIcon.className = 'bi bi-sun text-lg text-secondary-color';
            }
        }

        /**
         * Manually refreshes SLA data from the backend.
         * Shows loading state with spinning icon and updates UI on completion.
         * @returns {Promise<void>}
         */
        async function refreshSLAData() {
            const refreshButton = document.getElementById('refreshButton');
            const refreshIcon = document.getElementById('refreshIcon');
            
            if (!refreshButton || !refreshIcon) {
                console.warn('Refresh button elements not found');
                return;
            }
            
            // Check if we're in GAS environment
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                showNotification('Refresh not available in local development mode', 'info');
                return;
            }
            
            try {
                // Disable button and show loading state
                refreshButton.disabled = true;
                refreshIcon.classList.add('animate-spin');
                console.log('🔄 Manual refresh triggered by user');
                
                // Call the backend to refresh data
                const success = await loadSLAsFromBackend();
                
                if (success) {
                    showNotification('Data refreshed successfully!', 'success');
                    console.log('✅ Manual refresh completed successfully');
                } else {
                    showNotification('Failed to refresh data', 'error');
                    console.error('❌ Manual refresh failed');
                }
                
            } catch (error) {
                console.error('Error during manual refresh:', error);
                showNotification('Error refreshing data: ' + error.message, 'error');
            } finally {
                // Re-enable button and stop spinning
                refreshButton.disabled = false;
                refreshIcon.classList.remove('animate-spin');
            }
        }

        /**
         * Copies text to the system clipboard using the Clipboard API.
         * Shows success/error notification after copy attempt.
         * @param {string} text - Text to copy to clipboard
         * @returns {Promise<void>}
         */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('JSON copied to clipboard!');
            }).catch(() => {
                showNotification('Failed to copy JSON', 'error');
            });
        }

        // Initialize progress bar animations
        document.addEventListener('DOMContentLoaded', function() {
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 500);
            });
            
            // Initialize tab title listeners
            attachTabTitleListeners();
            
            // Organize task list with user's task at top (after data is loaded)
            setTimeout(() => {
                if (window.APP_DATA.userData) {
                    organizeTaskList();
                }
            }, 500);
        });
    </script>
</body>
</html>